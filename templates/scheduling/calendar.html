{% extends 'base.html' %}
{% load static %}

{% block title %}일정 관리 - 운산자동차 CRM{% endblock %}

{% block extra_head %}
<!-- 커스텀 캘린더 스타일 -->
<style>
.calendar-day {
    min-height: 100px;
    cursor: pointer;
    position: relative;
}

.calendar-day:hover {
    background-color: rgb(249 250 251); /* hover:bg-gray-50 */
}

.dark .calendar-day:hover {
    background-color: rgb(75 85 99); /* dark:hover:bg-gray-600 */
}

.calendar-day.selected {
    position: relative;
}

.calendar-day.selected::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(59, 130, 246, 0.15); /* bg-blue-500/15 */
    pointer-events: none;
    z-index: 1;
}

.dark .calendar-day.selected::before {
    background-color: rgba(96, 165, 250, 0.2); /* dark:bg-blue-400/20 */
}

.calendar-day.selected > * {
    position: relative;
    z-index: 2;
}

.calendar-event {
    display: block;
    font-size: 0.75rem;
    line-height: 1rem;
    margin-bottom: 0.125rem;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    color: white;
    text-decoration: none;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}

.calendar-event:hover {
    opacity: 0.8;
}

.calendar-event.engine-oil { background-color: rgb(59 130 246); } /* blue-500 */
.calendar-event.insurance { background-color: rgb(34 197 94); } /* green-500 */
.calendar-event.happycall { background-color: rgb(245 158 11); } /* yellow-500 */
.calendar-event.admin { background-color: rgb(139 92 246); } /* purple-500 */

/* 강조된 이벤트 스타일 */
.highlighted-event {
    animation: pulse-highlight 2s infinite;
    border: 2px solid #f59e0b !important;
    box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.3) !important;
    transform: scale(1.05);
    z-index: 10;
    position: relative;
}

@keyframes pulse-highlight {
    0%, 100% {
        box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.3);
    }
    50% {
        box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.5);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">일정 관리 v2.0</h1>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                팀별 일정을 관리하고 공유합니다
            </p>
        </div>
    </div>

    <!-- Department Tabs Section -->
    <div class="border-b border-gray-200 pb-5 sm:pb-0 dark:border-white/10">
        <div class="mt-3 sm:mt-4">
            <!-- Mobile Dropdown -->
            <div class="sm:hidden">
                <select id="mobileDepartmentSelect" aria-label="Select a department" class="col-start-1 row-start-1 w-full appearance-none rounded-md bg-white py-2 pl-3 pr-8 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 dark:bg-white/5 dark:text-white dark:outline-white/10 dark:*:bg-gray-800 dark:focus:outline-white">
                    <option value="all">전체</option>
                    <option value="admin">관리부서</option>
                    <option value="engine_oil">엔진오일팀</option>
                    <option value="happycall">해피콜팀</option>
                    <option value="insurance">보험영업팀</option>
                </select>
                <svg viewBox="0 0 16 16" fill="currentColor" data-slot="icon" aria-hidden="true" class="pointer-events-none col-start-1 row-start-1 mr-2 size-5 self-center justify-self-end fill-gray-500 dark:fill-gray-400">
                    <path d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" fill-rule="evenodd" />
                </svg>
            </div>
            <!-- Desktop Tabs -->
            <div class="hidden sm:block">
                <nav class="-mb-px flex space-x-8">
                    <button data-dept="all" class="department-tab whitespace-nowrap border-b-2 border-indigo-500 px-1 pb-4 text-sm font-medium text-indigo-600 dark:border-indigo-400 dark:text-indigo-400" aria-current="page">전체</button>
                    <button data-dept="admin" class="department-tab whitespace-nowrap border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700 dark:text-gray-400 dark:hover:border-white/20 dark:hover:text-white">관리부서</button>
                    <button data-dept="engine_oil" class="department-tab whitespace-nowrap border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700 dark:text-gray-400 dark:hover:border-white/20 dark:hover:text-white">엔진오일팀</button>
                    <button data-dept="happycall" class="department-tab whitespace-nowrap border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700 dark:text-gray-400 dark:hover:border-white/20 dark:hover:text-white">해피콜팀</button>
                    <button data-dept="insurance" class="department-tab whitespace-nowrap border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700 dark:text-gray-400 dark:hover:border-white/20 dark:hover:text-white">보험영업팀</button>
                </nav>
            </div>
        </div>
    </div>

    <!-- Employee Selection Section -->
    <div class="border-b border-gray-200 pb-5 dark:border-white/10">
        <div class="flex items-center justify-between cursor-pointer" onclick="toggleEmployeeSection()">
            <h3 class="text-base font-semibold text-gray-900 dark:text-white">직원 선택</h3>
            <svg id="employee-section-icon" class="w-5 h-5 text-gray-500 transform transition-transform duration-200" style="transform: rotate(-90deg);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </div>
        <div id="employee-section-content" class="mt-4" style="display: none;">
            <!-- Control Buttons -->
            <div class="flex gap-2 mb-4">
                <button onclick="selectAllEmployees('employeeFilter-current')" class="px-3 py-1 text-xs bg-indigo-600 text-white rounded hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1">
                    전체선택
                </button>
                <button onclick="deselectAllEmployees('employeeFilter-current')" class="px-3 py-1 text-xs bg-gray-600 text-white rounded hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-1">
                    전체해제
                </button>
            </div>
            <!-- Employee Checkboxes -->
            <div id="employeeFilter-current" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                <!-- 전체 직원 체크박스 -->
                {% for employee in employees %}
                    <label class="employee-item inline-flex items-center" data-department="{% if employee.department %}{{ employee.department.display_name }}{% else %}admin{% endif %}">
                        <input type="checkbox" value="{{ employee.user.username }}" class="employee-checkbox rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" checked>
                        <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">{{ employee.get_position_display }} {{ employee.user.last_name }}{{ employee.user.first_name|default:employee.user.username }}</span>
                    </label>
                {% endfor %}
            </div>
        </div>
    </div>


    <!-- Tailwind Calendar -->
    <div class="lg:flex lg:h-full lg:flex-col">
        <header class="flex items-center justify-between border-b border-gray-200 px-6 py-4 lg:flex-none dark:border-white/10 dark:bg-gray-800/50">
            <h1 class="text-base font-semibold text-gray-900 dark:text-white">
                <time id="calendar-title" datetime="2024-08">2024년 8월</time>
            </h1>
            <div class="flex items-center">
                <div class="relative flex items-center rounded-md bg-white shadow-sm outline outline-1 -outline-offset-1 outline-gray-300 md:items-stretch dark:bg-white/10 dark:shadow-none dark:outline-white/5">
                    <button type="button" id="prevMonth" class="flex h-9 w-12 items-center justify-center rounded-l-md pr-1 text-gray-400 hover:text-gray-500 focus:relative md:w-9 md:pr-0 md:hover:bg-gray-50 dark:hover:text-white dark:md:hover:bg-white/10">
                        <span class="sr-only">이전 달</span>
                        <svg viewBox="0 0 20 20" fill="currentColor" data-slot="icon" aria-hidden="true" class="size-5">
                            <path d="M11.78 5.22a.75.75 0 0 1 0 1.06L8.06 10l3.72 3.72a.75.75 0 1 1-1.06 1.06l-4.25-4.25a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" fill-rule="evenodd" />
                        </svg>
                    </button>
                    <button type="button" id="todayBtn" class="hidden px-3.5 text-sm font-semibold text-gray-900 hover:bg-gray-50 focus:relative md:block dark:text-white dark:hover:bg-white/10">오늘</button>
                    <span class="relative -mx-px h-5 w-px bg-gray-300 md:hidden dark:bg-white/10"></span>
                    <button type="button" id="nextMonth" class="flex h-9 w-12 items-center justify-center rounded-r-md pl-1 text-gray-400 hover:text-gray-500 focus:relative md:w-9 md:pl-0 md:hover:bg-gray-50 dark:hover:text-white dark:md:hover:bg-white/10">
                        <span class="sr-only">다음 달</span>
                        <svg viewBox="0 0 20 20" fill="currentColor" data-slot="icon" aria-hidden="true" class="size-5">
                            <path d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" fill-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div class="hidden md:ml-4 md:flex md:items-center">
                    <div class="relative">
                        <button type="button" id="viewSelector" class="flex items-center gap-x-1.5 rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 dark:bg-white/10 dark:text-white dark:shadow-none dark:ring-white/5 dark:hover:bg-white/20">
                            <span id="currentViewText">월간 보기</span>
                            <svg viewBox="0 0 20 20" fill="currentColor" data-slot="icon" aria-hidden="true" class="-mr-1 size-5 text-gray-400 dark:text-gray-500">
                                <path d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" fill-rule="evenodd" />
                            </svg>
                        </button>
                        
                        <div id="viewDropdown" class="absolute right-0 z-10 mt-2 w-36 origin-top-right overflow-hidden rounded-md bg-white p-0 shadow-lg ring-1 ring-black/5 transition transform scale-95 opacity-0 pointer-events-none dark:bg-gray-800 dark:ring-white/10">
                            <div class="py-1">
                                <a href="#" data-view="day" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-white/5 dark:hover:text-white">일간 보기</a>
                                <a href="#" data-view="month" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-white/5 dark:hover:text-white">월간 보기</a>
                            </div>
                        </div>
                    </div>
                    <div class="ml-6 h-6 w-px bg-gray-300 dark:bg-white/10"></div>
                    <a href="{% url 'scheduling:add_schedule_view' %}" class="ml-6 rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 dark:bg-indigo-500 dark:shadow-none dark:hover:bg-indigo-400 dark:focus-visible:outline-indigo-500 no-underline inline-block">일정 추가</a>
                </div>
            </div>
        </header>
        
        <!-- Month View -->
        <div id="monthView" class="shadow ring-1 ring-black/5 lg:flex lg:flex-auto lg:flex-col dark:shadow-none dark:ring-white/5">
            <div class="grid grid-cols-7 gap-px border-b border-gray-300 bg-gray-200 text-center text-xs/6 font-semibold text-gray-700 lg:flex-none dark:border-white/5 dark:bg-white/15 dark:text-gray-300">
                <div class="flex justify-center bg-white py-2 dark:bg-gray-900">
                    <span>월</span>
                </div>
                <div class="flex justify-center bg-white py-2 dark:bg-gray-900">
                    <span>화</span>
                </div>
                <div class="flex justify-center bg-white py-2 dark:bg-gray-900">
                    <span>수</span>
                </div>
                <div class="flex justify-center bg-white py-2 dark:bg-gray-900">
                    <span>목</span>
                </div>
                <div class="flex justify-center bg-white py-2 dark:bg-gray-900">
                    <span>금</span>
                </div>
                <div class="flex justify-center bg-white py-2 dark:bg-gray-900">
                    <span>토</span>
                </div>
                <div class="flex justify-center bg-white py-2 dark:bg-gray-900">
                    <span>일</span>
                </div>
            </div>
            <div class="flex bg-gray-200 text-xs/6 text-gray-700 lg:flex-auto dark:bg-white/10 dark:text-gray-300">
                <div class="hidden w-full lg:grid lg:grid-cols-7 lg:gap-px" id="calendar-grid">
                    <!-- 캘린더 날짜 셀들이 여기에 동적으로 생성됩니다 -->
                </div>
            </div>
        </div>
        
        
        <!-- Day View -->
        <div id="dayView" class="hidden isolate flex flex-auto overflow-hidden bg-white dark:bg-gray-900">
            <!-- Day view content will be dynamically generated -->
        </div>
    </div>

    <!-- 선택된 날짜의 일정 상세 -->
    <div id="dailySchedulePanel" class="bg-white dark:bg-gray-800 rounded-lg shadow" style="display: none;">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 id="selectedDateTitle" class="text-lg font-semibold text-gray-900 dark:text-white">
                    2024년 8월 30일 일정
                </h3>
                <button id="closeDailyPanel" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div id="dailyScheduleList" class="space-y-3">
                <!-- 일정 목록이 여기에 동적으로 추가됩니다 -->
            </div>
            
            <div id="noScheduleMessage" class="text-center py-8 text-gray-500 dark:text-gray-400" style="display: none;">
                선택된 날짜에 일정이 없습니다.
            </div>
        </div>
    </div>
</div>

<!-- Event Detail Modal -->
<div id="eventModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-6 w-11/12 md:w-2/3 lg:w-1/2 max-w-2xl">
        <div class="overflow-hidden bg-white shadow sm:rounded-lg dark:bg-gray-800/50 dark:shadow-none dark:ring-1 dark:ring-inset dark:ring-white/10">
            <!-- Header -->
            <div class="px-4 py-6 sm:px-6">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-base/7 font-semibold text-gray-900 dark:text-white" id="modalTitle">일정 상세</h3>
                        <p class="mt-1 max-w-2xl text-sm/6 text-gray-500 dark:text-gray-300" id="modalTime">일정 시간 정보</p>
                    </div>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 p-1 rounded-md hover:bg-gray-50 dark:hover:bg-white/5 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Content -->
            <div class="border-t border-gray-100 dark:border-white/5">
                <dl class="divide-y divide-gray-100 dark:divide-white/5">
                    <!-- Description -->
                    <div class="px-4 py-3 sm:grid sm:grid-cols-4 sm:gap-4 sm:px-6">
                        <dt class="text-sm font-bold text-gray-900 dark:text-gray-100">설명</dt>
                        <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-3 sm:mt-0 dark:text-gray-300" id="modalDescription">-</dd>
                    </div>
                    
                    <!-- Location -->
                    <div class="px-4 py-3 sm:grid sm:grid-cols-4 sm:gap-4 sm:px-6">
                        <dt class="text-sm font-bold text-gray-900 dark:text-gray-100">장소</dt>
                        <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-3 sm:mt-0 dark:text-gray-300" id="modalLocation">-</dd>
                    </div>
                    
                    <!-- Assignee -->
                    <div class="px-4 py-3 sm:grid sm:grid-cols-4 sm:gap-4 sm:px-6">
                        <dt class="text-sm font-bold text-gray-900 dark:text-gray-100">담당자</dt>
                        <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-3 sm:mt-0 dark:text-gray-300" id="modalAssignee">-</dd>
                    </div>
                    
                    <!-- Department -->
                    <div class="px-4 py-3 sm:grid sm:grid-cols-4 sm:gap-4 sm:px-6">
                        <dt class="text-sm font-bold text-gray-900 dark:text-gray-100">부서</dt>
                        <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-3 sm:mt-0 dark:text-gray-300" id="modalDepartment">-</dd>
                    </div>
                    
                    <!-- Status and Priority -->
                    <div class="px-4 py-3 sm:grid sm:grid-cols-4 sm:gap-4 sm:px-6">
                        <dt class="text-sm font-bold text-gray-900 dark:text-gray-100">상태 및 <br>우선순위</dt>
                        <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-3 sm:mt-0 dark:text-gray-300">
                            <div class="space-y-1">
                                <div class="flex items-center gap-1">
                                    <span class="text-xs text-gray-500 dark:text-gray-400">상태:</span>
                                    <span id="modalStatus">-</span>
                                </div>
                                <div class="flex items-center gap-1">
                                    <span class="text-xs text-gray-500 dark:text-gray-400">우선순위:</span>
                                    <span id="modalPriority">-</span>
                                </div>
                            </div>
                        </dd>
                    </div>
                    
                    <!-- Actions -->
                    <div class="px-4 py-4 sm:px-6">
                        <div class="flex justify-center items-center gap-3">
                            <button id="editEventBtn" class="inline-flex items-center gap-2 rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 dark:bg-white/5 dark:text-white dark:ring-white/10 dark:hover:bg-white/10">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                수정
                            </button>
                            <button id="deleteEventBtn" class="inline-flex items-center gap-2 rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-600 dark:bg-red-500 dark:hover:bg-red-400">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                삭제
                            </button>
                        </div>
                    </div>
                </dl>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Tailwind 캘린더 초기화');
    
    // 전역 변수
    let currentDate = new Date();
    let calendarEvents = [];
    let currentView = 'month';
    const modal = document.getElementById('eventModal');
    const closeModalBtn = document.getElementById('closeModal');
    
    // 현재 사용자 정보
    const currentUser = {
        username: '{{ user.username }}',
        is_superuser: {{ user.is_superuser|yesno:"true,false" }}
    };
    
    // 초기 뷰 설정
    initializeViews();
    
    // 캘린더 렌더링
    renderCalendar();
    
    // 초기 뷰 설정 함수
    function initializeViews() {
        // 월간 뷰만 표시, 일간 뷰는 숨기기
        const monthView = document.getElementById('monthView');
        const dayView = document.getElementById('dayView');
        
        if (monthView) monthView.style.display = 'flex';
        if (dayView) dayView.style.display = 'none';
        
        console.log('Views initialized - month view visible');
    }
    
    // 캘린더 렌더링 함수
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        // 제목 업데이트
        const titleEl = document.getElementById('calendar-title');
        titleEl.textContent = `${year}년 ${month + 1}월`;
        titleEl.setAttribute('datetime', `${year}-${String(month + 1).padStart(2, '0')}`);
        
        // 첫째 날과 마지막 날
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        
        // 월요일부터 시작하도록 조정 (0=일요일, 1=월요일)
        const startDay = (firstDay.getDay() + 6) % 7; // 월요일을 0으로 만들기
        
        // 필요한 주 수 계산
        const totalDays = lastDay.getDate(); // 이번 달 총 일 수
        const totalCells = startDay + totalDays; // 시작 빈 셀 + 이번 달 일 수
        const weeksNeeded = Math.ceil(totalCells / 7); // 필요한 주 수
        const totalGridCells = weeksNeeded * 7; // 실제 그리드 셀 수
        
        // 캘린더 그리드 생성
        const calendarGrid = document.getElementById('calendar-grid');
        calendarGrid.innerHTML = '';
        
        // 동적 grid-rows 클래스와 스타일 설정
        calendarGrid.className = `hidden w-full lg:grid lg:grid-cols-7`;
        calendarGrid.style.gridTemplateRows = `repeat(${weeksNeeded}, minmax(100px, auto))`;
        
        // 계산된 셀 수만큼 생성
        for (let i = 0; i < totalGridCells; i++) {
            const cellDate = new Date(year, month, i - startDay + 1);
            const isCurrentMonth = cellDate.getMonth() === month;
            const isToday = cellDate.toDateString() === new Date().toDateString();
            
            const dayCell = document.createElement('div');
            dayCell.className = `calendar-day group relative bg-gray-50 px-3 py-2 text-gray-500 border-t border-l border-gray-200 ${isCurrentMonth ? 'data-[is-current-month]:bg-white' : ''} dark:bg-gray-900 dark:text-gray-400 dark:data-[is-current-month]:bg-gray-900 dark:border-white/10`;
            
            if (isCurrentMonth) {
                dayCell.setAttribute('data-is-current-month', '');
                dayCell.classList.add('bg-white');
                dayCell.classList.remove('bg-gray-50');
            }
            
            if (isToday) {
                dayCell.setAttribute('data-is-today', '');
            }
            
            const timeEl = document.createElement('time');
            // 로컬 날짜로 datetime 속성 설정 (timezone 오프셋 문제 해결)
            const cellYear = cellDate.getFullYear();
            const cellMonth = String(cellDate.getMonth() + 1).padStart(2, '0');
            const cellDay = String(cellDate.getDate()).padStart(2, '0');
            const cellDateStr = `${cellYear}-${cellMonth}-${cellDay}`;
            timeEl.setAttribute('datetime', cellDateStr);
            timeEl.className = `relative group-[:not([data-is-current-month])]:opacity-75 ${isToday ? 'flex size-6 items-center justify-center rounded-full bg-red-600 font-semibold text-white dark:bg-red-500' : ''}`;
            timeEl.textContent = cellDate.getDate();
            
            dayCell.appendChild(timeEl);
            
            // 이벤트 카운트 표시를 위한 빈 공간 (renderEvents에서 동적 추가)
            
            // 오른쪽 끝 셀에 우측 테두리 추가
            if ((i + 1) % 7 === 0) {
                dayCell.classList.add('border-r');
            }
            
            // 마지막 행 셀에 하단 테두리 추가
            if (i >= totalGridCells - 7) {
                dayCell.classList.add('border-b');
            }
            
            // 날짜 클릭 이벤트
            dayCell.addEventListener('click', () => {
                // 이전 선택된 날짜 스타일 제거
                document.querySelectorAll('.calendar-day.selected').forEach(cell => {
                    cell.classList.remove('selected');
                });
                
                // 현재 클릭된 날짜에 선택된 스타일 추가
                dayCell.classList.add('selected');
                
                const year = cellDate.getFullYear();
                const month = String(cellDate.getMonth() + 1).padStart(2, '0');
                const day = String(cellDate.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                console.log('클릭된 날짜:', cellDate.getDate(), '전달되는 날짜:', dateStr);
                showDailySchedules(dateStr);
            });
            
            calendarGrid.appendChild(dayCell);
        }
        
        // 이벤트 로드
        loadEvents();
    }
    
    // 이벤트 로드 함수
    function loadEvents() {
        const activeTab = getCurrentDepartmentTab();
        const checkedEmployees = getCheckedEmployees();
        
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        // 캘린더 그리드에 표시되는 모든 날짜 범위를 포함하도록 확장
        // 이전 달 마지막 주부터 다음 달 첫 주까지 넉넉하게 로드
        const startDate = new Date(year, month - 1, 15); // 이전 달 15일부터
        const endDate = new Date(year, month + 2, 15); // 다음다음 달 15일까지
        
        console.log('월간보기 로드 범위:', startDate.toISOString().split('T')[0], '~', endDate.toISOString().split('T')[0]);
        console.log('현재 날짜:', currentDate, '년월:', year, month);
        
        // 부서 필터링 적용 (서버 API용 부서명 매핑)
        let mappedDepartment = activeTab;
        if (activeTab !== 'all') {
            const departmentMapping = {
                'admin': '관리부서',
                'engine_oil': '엔진오일팀', 
                'insurance': '보험영업팀',
                'happycall': '해피콜팀'
            };
            mappedDepartment = departmentMapping[activeTab] || activeTab;
        }
        console.log('월간보기 부서 매핑:', activeTab, '→', mappedDepartment);
        
        const params = new URLSearchParams({
            start: startDate.toISOString().split('T')[0],
            end: endDate.toISOString().split('T')[0],
            assignees: checkedEmployees.join(',')
        });
        
        // 전체 부서가 아닐 때만 department 파라미터 추가
        if (activeTab !== 'all') {
            params.set('department', mappedDepartment);
        }
        
        const finalUrl = `{% url "scheduling:api_events" %}?${params}`;
        
        fetch(finalUrl)
            .then(response => {
                console.log('월간보기 서버 응답 상태:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(events => {
                calendarEvents = events;
                window.currentEvents = events; // 전역 변수에 저장
                renderEvents();
            })
            .catch(error => {
                console.error('일정 로드 실패:', error);
                alert('일정을 불러올 수 없습니다: ' + error.message);
            });
    }
    
    // 이벤트 렌더링 함수
    function renderEvents() {
        // 모든 이벤트 카운터 초기화 (강제로 모든 카운트 요소 제거)
        document.querySelectorAll('#calendar-grid .event-count').forEach(counter => {
            counter.remove();
        });
        
        // calendarEvents가 배열이 아닌 경우 처리
        if (!Array.isArray(calendarEvents)) {
            console.error('calendarEvents가 배열이 아닙니다:', calendarEvents);
            return;
        }
        
        // 날짜별 이벤트 카운트
        const eventCountByDate = {};
        calendarEvents.forEach((event) => {
            if (!event.start) {
                return;
            }
            
            const eventDate = new Date(event.start);
            // 로컬 날짜로 변환 (timezone 오프셋 문제 해결)
            const year = eventDate.getFullYear();
            const month = String(eventDate.getMonth() + 1).padStart(2, '0');
            const day = String(eventDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            
            eventCountByDate[dateStr] = (eventCountByDate[dateStr] || 0) + 1;
        });
        
        // 모든 날짜 셀에 카운트 또는 빈 공간 추가
        const allDayCells = document.querySelectorAll('#calendar-grid .calendar-day');
        allDayCells.forEach((dayCell) => {
            const timeEl = dayCell.querySelector('time');
            if (!timeEl) {
                return;
            }
            
            const dateStr = timeEl.getAttribute('datetime');
            const count = eventCountByDate[dateStr] || 0;
            
            // 기존 카운트 표시 요소 제거 (모든 카운트 관련 요소)
            const existingCounts = dayCell.querySelectorAll('.event-count');
            existingCounts.forEach(el => el.remove());
            
            // 카운트가 0보다 클 때만 요소 생성 및 추가
            if (count > 0) {
                const countEl = document.createElement('div');
                countEl.className = 'event-count mt-2 text-xs text-center min-h-[18px] mx-1 bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded font-medium dark:bg-indigo-900/50 dark:text-indigo-300';
                countEl.textContent = `${count}건`;
                
                // 카운트가 많을 때 다른 색상 사용
                if (count >= 5) {
                    countEl.classList.remove('bg-indigo-100', 'text-indigo-800', 'dark:bg-indigo-900/50', 'dark:text-indigo-300');
                    countEl.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900/50', 'dark:text-red-300');
                }
                
                dayCell.appendChild(countEl);
            }
        });
    }
    
    // 이벤트 모달 표시
    function showEventModal(event) {
        const modal = document.getElementById('eventModal');
        const startDate = new Date(event.start);
        const endDate = new Date(event.end);
        const timeStr = startDate.toLocaleString('ko-KR', { 
            month: 'long', 
            day: 'numeric', 
            weekday: 'long',
            hour: '2-digit', 
            minute: '2-digit' 
        }) + ' ~ ' + endDate.toLocaleTimeString('ko-KR', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        document.getElementById('modalTitle').textContent = event.title;
        document.getElementById('modalTime').textContent = timeStr;
        document.getElementById('modalDescription').textContent = event.extendedProps?.description || '설명이 없습니다.';
        document.getElementById('modalLocation').textContent = event.extendedProps?.location || '장소가 지정되지 않았습니다.';
        document.getElementById('modalAssignee').textContent = event.extendedProps?.assignee || '담당자가 지정되지 않았습니다.';
        document.getElementById('modalDepartment').textContent = event.extendedProps?.department || '부서 정보 없음';
        
        // 상태 스타일링
        const statusEl = document.getElementById('modalStatus');
        const statusMap = {
            'pending': { text: '대기중', class: 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800' },
            'confirmed': { text: '확인됨', class: 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800' },
            'completed': { text: '완료', class: 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800' },
            'cancelled': { text: '취소됨', class: 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800' }
        };
        const statusInfo = statusMap[event.extendedProps?.status] || { 
            text: event.extendedProps?.status || '상태 없음', 
            class: 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800' 
        };
        statusEl.textContent = statusInfo.text;
        statusEl.className = statusInfo.class;
        
        // 우선순위 스타일링
        const priorityEl = document.getElementById('modalPriority');
        const priorityMap = {
            'low': { text: '낮음', class: 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800' },
            'normal': { text: '보통', class: 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800' },
            'high': { text: '높음', class: 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800' },
            'urgent': { text: '긴급', class: 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800' }
        };
        const priorityInfo = priorityMap[event.extendedProps?.priority] || { 
            text: event.extendedProps?.priority || '우선순위 없음', 
            class: 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800' 
        };
        priorityEl.textContent = priorityInfo.text;
        priorityEl.className = priorityInfo.class;
        
        // 권한 체크 후 버튼 표시/비표시
        const editBtn = document.getElementById('editEventBtn');
        const deleteBtn = document.getElementById('deleteEventBtn');
        
        const canEdit = canEditEvent(event);
        const canDelete = canDeleteEvent(event);
        
        editBtn.style.display = canEdit ? 'inline-flex' : 'none';
        deleteBtn.style.display = canDelete ? 'inline-flex' : 'none';
        
        if (canEdit || canDelete) {
            // 기존 이벤트 리스너 제거
            editBtn.replaceWith(editBtn.cloneNode(true));
            deleteBtn.replaceWith(deleteBtn.cloneNode(true));
            
            // 새로운 이벤트 리스너 추가
            if (canEdit) {
                document.getElementById('editEventBtn').addEventListener('click', () => editEvent(event));
            }
            if (canDelete) {
                document.getElementById('deleteEventBtn').addEventListener('click', () => deleteEvent(event));
            }
        }
        
        modal.classList.remove('hidden');
    }
    
    // 네비게이션 함수 (뷰에 따라 다르게 동작)
    function navigatePrevious() {
        document.getElementById('dailySchedulePanel').style.display = 'none';
        
        if (currentView === 'month') {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
            updateMonthTitle();
        } else if (currentView === 'day') {
            currentDate.setDate(currentDate.getDate() - 1);
            renderDayView();
            updateDayTitle();
        }
    }
    
    function navigateNext() {
        document.getElementById('dailySchedulePanel').style.display = 'none';
        
        if (currentView === 'month') {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
            updateMonthTitle();
        } else if (currentView === 'day') {
            currentDate.setDate(currentDate.getDate() + 1);
            renderDayView();
            updateDayTitle();
        }
    }
    
    // 오늘로 이동
    function goToToday() {
        document.getElementById('dailySchedulePanel').style.display = 'none';
        currentDate = new Date();
        
        if (currentView === 'month') {
            renderCalendar();
            updateMonthTitle();
        } else if (currentView === 'day') {
            renderDayView();
            updateDayTitle();
        }
    }
    
    // 제목 업데이트 함수들
    function updateMonthTitle() {
        const titleEl = document.getElementById('calendar-title');
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1;
        titleEl.textContent = `${year}년 ${month}월`;
        titleEl.setAttribute('datetime', `${year}-${String(month).padStart(2, '0')}`);
    }
    
    
    function updateDayTitle() {
        const titleEl = document.getElementById('calendar-title');
        const month = currentDate.getMonth() + 1;
        const day = currentDate.getDate();
        const dayNames = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
        const dayName = dayNames[currentDate.getDay()];
        
        titleEl.textContent = `${month}월 ${day}일 ${dayName}`;
        titleEl.setAttribute('datetime', currentDate.toISOString().split('T')[0]);
    }
    
    // 이벤트 리스너 등록 (뷰에 따라 다르게 동작)
    document.getElementById('prevMonth').addEventListener('click', () => navigatePrevious());
    document.getElementById('nextMonth').addEventListener('click', () => navigateNext());
    document.getElementById('todayBtn').addEventListener('click', goToToday);
    
    // 하단 패널 관련 이벤트 리스너
    document.getElementById('closeDailyPanel').addEventListener('click', function() {
        document.getElementById('dailySchedulePanel').style.display = 'none';
    });
    
    // Modal 닫기
    closeModalBtn.addEventListener('click', function() {
        modal.classList.add('hidden');
    });
    
    // Modal 외부 클릭시 닫기
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.classList.add('hidden');
        }
    });
    
    // 일정 수정 함수
    function editEvent(event) {
        // 일정 추가 페이지로 이동하면서 수정 모드로 설정
        const editUrl = `{% url "scheduling:add_schedule_view" %}?edit=${event.id}`;
        window.location.href = editUrl;
    }
    
    // 일정 삭제 함수
    function deleteEvent(event) {
        if (!confirm(`"${event.title}" 일정을 삭제하시겠습니까?`)) {
            return;
        }
        
        fetch(`/scheduling/api/delete/${event.id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                modal.classList.add('hidden');
                refreshCalendar(); // 캘린더 새로고침
            } else {
                alert('삭제 실패: ' + data.message);
            }
        })
        .catch(error => {
            console.error('삭제 오류:', error);
            alert('삭제 중 오류가 발생했습니다.');
        });
    }
    
    // 권한 체크 함수들
    function canEditEvent(event) {
        // 최고 관리자는 모든 일정 수정 가능
        if (currentUser.is_superuser) {
            return true;
        }
        
        const creatorUsername = event.extendedProps?.creator_username;
        const assigneeUsername = event.extendedProps?.assignee_username;
        const departmentManagerUsername = event.extendedProps?.department_manager_username;
        
        // 생성자, 담당자, 부서 관리자는 수정 가능
        return (
            currentUser.username === creatorUsername ||
            currentUser.username === assigneeUsername ||
            currentUser.username === departmentManagerUsername
        );
    }
    
    function canDeleteEvent(event) {
        // 최고 관리자는 모든 일정 삭제 가능
        if (currentUser.is_superuser) {
            return true;
        }
        
        const creatorUsername = event.extendedProps?.creator_username;
        const departmentManagerUsername = event.extendedProps?.department_manager_username;
        
        // 생성자나 부서 관리자만 삭제 가능
        return (
            currentUser.username === creatorUsername ||
            currentUser.username === departmentManagerUsername
        );
    }
    
    // CSRF 토큰 가져오기 함수
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // 캘린더 새로고침 함수
    function refreshCalendar() {
        if (currentView === 'month') {
            loadEvents();
        } else if (currentView === 'day') {
            loadDayEvents();
        }
        // 하단 패널도 숨기기
        document.getElementById('dailySchedulePanel').style.display = 'none';
    }
    
    // 선택된 날짜의 일정을 하단에 표시하는 함수
    function showDailySchedules(dateStr) {
        console.log('날짜 클릭:', dateStr);
        
        // 패널 표시
        const panel = document.getElementById('dailySchedulePanel');
        const titleEl = document.getElementById('selectedDateTitle');
        const listEl = document.getElementById('dailyScheduleList');
        const noScheduleEl = document.getElementById('noScheduleMessage');
        
        // 날짜 형식 변환
        const date = new Date(dateStr);
        const formattedDate = date.toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'long'
        });
        
        // 이미 로드된 calendarEvents에서 해당 날짜의 이벤트 필터링
        const dayEvents = calendarEvents.filter(event => {
            const eventDate = new Date(event.start);
            // 로컬 날짜로 변환 (timezone 오프셋 문제 해결)
            const year = eventDate.getFullYear();
            const month = String(eventDate.getMonth() + 1).padStart(2, '0');
            const day = String(eventDate.getDate()).padStart(2, '0');
            const eventDateStr = `${year}-${month}-${day}`;
            return eventDateStr === dateStr;
        });
        
        // 부서별 통계 계산
        const departmentStats = {};
        dayEvents.forEach(event => {
            const dept = event.extendedProps?.department || '기타';
            departmentStats[dept] = (departmentStats[dept] || 0) + 1;
        });
        
        // 부서별 통계 문자열 생성
        const statsText = Object.keys(departmentStats).length > 0 ? 
            Object.entries(departmentStats).map(([dept, count]) => `${dept} ${count}건`).join(', ') : '';
        
        titleEl.innerHTML = `
            <div class="text-lg font-semibold text-gray-900 dark:text-white">
                ${formattedDate} 일정
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                총 ${dayEvents.length}건${statsText ? ` (${statsText})` : ''}
            </div>
        `;
        
        console.log(`캘린더 카운트와 비교: ${dayEvents.length}건`);
        
        listEl.innerHTML = '';
        
        if (dayEvents.length === 0) {
            noScheduleEl.style.display = 'block';
        } else {
            noScheduleEl.style.display = 'none';
            
            // 시간순 정렬
            dayEvents.sort((a, b) => new Date(a.start) - new Date(b.start));
            
            dayEvents.forEach(event => {
                const eventEl = createScheduleItem(event);
                listEl.appendChild(eventEl);
            });
        }
        
        panel.style.display = 'block';
        // 부드럽게 스크롤
        panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    // 일정 아이템 HTML 생성 함수
    function createScheduleItem(event) {
        const div = document.createElement('div');
        div.className = 'border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors';
        div.setAttribute('data-event-id', event.id); // 이벤트 ID 속성 추가
        
        const startDate = new Date(event.start);
        const endDate = new Date(event.end);
        const timeStr = startDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) +
                       ' - ' +
                       endDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        
        // 부서별 색상 매핑 (실제 데이터에 맞춘 부서명)
        const departmentColors = {
            'admin': '#6366F1', // indigo-500
            'engine_oil': '#3B82F6', // blue-500  
            'insurance': '#059669', // emerald-600
            'happycall': '#D97706', // amber-600
            '영업부': '#059669', // emerald-600
            '정비부': '#7C3AED', // violet-600
            '인사부': '#DC2626', // red-600
            'IT부': '#0891B2', // cyan-600
            '관리부': '#6366F1', // indigo-500
            // 실제 데이터에서 오는 부서명들
            '관리부서': '#6366F1', // indigo-500
            '엔진오일팀': '#3B82F6', // blue-500
            '보험영업팀': '#059669', // emerald-600
            '해피콜팀': '#D97706' // amber-600
        };
        
        const dept = event.extendedProps?.department || 'admin';
        const assignee = event.extendedProps?.assignee || '담당자 미지정';
        const deptColor = departmentColors[dept] || '#6B7280';
        
        // 부서 - 담당자 형태로 표시
        const deptAssigneeText = `${dept} - ${assignee}`;
        
        
        div.innerHTML = `
            <div class="flex">
                <div class="w-1 flex-shrink-0" style="background-color: ${deptColor}; opacity: 0.6;"></div>
                <div class="flex-1 p-4">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center space-x-2 text-sm font-medium text-gray-600 dark:text-gray-300">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>${timeStr}</span>
                        </div>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" style="background-color: ${deptColor}20; color: ${deptColor}">
                            ${deptAssigneeText}
                        </span>
                    </div>
                    <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-1">
                        ${event.title}
                    </h4>
                    ${event.extendedProps.description ? `<p class="text-sm text-gray-600 dark:text-gray-300 mb-2">${event.extendedProps.description}</p>` : ''}
                    <div class="flex items-center space-x-4 text-xs text-gray-500 dark:text-gray-400">
                        ${event.extendedProps.location ? `<span class="flex items-center space-x-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <span>${event.extendedProps.location}</span>
                        </span>` : ''}
                        ${event.extendedProps.assignee ? `<span class="flex items-center space-x-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <span>${event.extendedProps.assignee}</span>
                        </span>` : ''}
                    </div>
                </div>
            </div>
        `;
        
        // 클릭 시 상세 모달 열기
        div.addEventListener('click', () => {
            showEventModal(event);
        });
        
        return div;
    }
    
    // 현재 활성화된 부서 탭 가져오기
    function getCurrentDepartmentTab() {
        const activeDesktopTab = document.querySelector('.department-tab.border-indigo-500');
        if (activeDesktopTab) {
            return activeDesktopTab.dataset.dept;
        }
        
        // 모바일에서는 select 값 확인
        const mobileSelect = document.getElementById('mobileDepartmentSelect');
        return mobileSelect ? mobileSelect.value : 'all';
    }
    
    // 체크된 직원들의 username 배열 가져오기
    function getCheckedEmployees() {
        const activeTab = getCurrentDepartmentTab();
        const employeeContainer = document.getElementById('employeeFilter-current');
        if (!employeeContainer) return [];
        
        let checkedBoxes;
        if (activeTab === 'all') {
            // 전체 탭일 때는 모든 체크된 직원
            checkedBoxes = employeeContainer.querySelectorAll('.employee-checkbox:checked');
        } else {
            // 특정 부서 탭일 때는 현재 표시되는 직원들 중 체크된 직원만
            const visibleItems = Array.from(employeeContainer.querySelectorAll('.employee-item'))
                .filter(item => item.style.display !== 'none');
            checkedBoxes = visibleItems
                .map(item => item.querySelector('.employee-checkbox'))
                .filter(checkbox => checkbox && checkbox.checked);
        }
        
        const result = Array.from(checkedBoxes).map(checkbox => checkbox.value);
        return result;
    }
    
    // 부서 탭 변경 처리
    function switchDepartmentTab(selectedDept) {
        // 데스크톱 탭 스타일 업데이트
        document.querySelectorAll('.department-tab').forEach(tab => {
            if (tab.dataset.dept === selectedDept) {
                tab.className = 'department-tab whitespace-nowrap border-b-2 border-indigo-500 px-1 pb-4 text-sm font-medium text-indigo-600 dark:border-indigo-400 dark:text-indigo-400';
                tab.setAttribute('aria-current', 'page');
            } else {
                tab.className = 'department-tab whitespace-nowrap border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700 dark:text-gray-400 dark:hover:border-white/20 dark:hover:text-white';
                tab.removeAttribute('aria-current');
            }
        });
        
        // 직원 목록 필터링 (표시/숨김)
        const employeeItems = document.querySelectorAll('.employee-item');
        
        console.log('부서 필터링 디버깅:', {
            selectedDept,
            totalEmployees: employeeItems.length,
            employeeDepartments: Array.from(employeeItems).map(item => ({
                name: item.querySelector('span').textContent,
                department: item.dataset.department
            }))
        });
        
        // 실제 HTML data-department 속성값과 직접 비교
        employeeItems.forEach(item => {
            const itemDept = item.dataset.department;
            let shouldShow = false;
            
            if (selectedDept === 'all') {
                shouldShow = true;
            } else if (selectedDept === 'admin' && (itemDept === '관리부서' || itemDept === '관리부' || itemDept === 'admin')) {
                shouldShow = true;
            } else if (selectedDept === 'engine_oil' && (itemDept === '엔진오일팀' || itemDept === 'engine_oil')) {
                shouldShow = true;
            } else if (selectedDept === 'insurance' && (itemDept === '보험영업팀' || itemDept === '영업부' || itemDept === 'insurance')) {
                shouldShow = true;
            } else if (selectedDept === 'happycall' && (itemDept === '해피콜팀' || itemDept === 'happycall')) {
                shouldShow = true;
            }
            
            item.style.display = shouldShow ? 'flex' : 'none';
        });
        
        // 모바일 select 동기화
        const mobileSelect = document.getElementById('mobileDepartmentSelect');
        if (mobileSelect && mobileSelect.value !== selectedDept) {
            mobileSelect.value = selectedDept;
        }
        
        // 캘린더 새로고침 (강제로 카운트 요소 먼저 제거)
        document.querySelectorAll('#calendar-grid .event-count').forEach(counter => {
            counter.remove();
        });
        refreshCalendar();
    }
    
    // 중복된 함수 정의 제거 (위에 이미 정의됨)
    
    // 데스크톱 탭 클릭 이벤트
    document.querySelectorAll('.department-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            switchDepartmentTab(this.dataset.dept);
        });
    });
    
    // 모바일 select 변경 이벤트
    document.getElementById('mobileDepartmentSelect').addEventListener('change', function() {
        switchDepartmentTab(this.value);
    });
    
    // 직원 체크박스 변경 시 캘린더 새로고침
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('employee-checkbox')) {
            refreshCalendar();
        }
    });
    
    // 전체선택 함수
    window.selectAllEmployees = function(filterId) {
        const activeTab = getCurrentDepartmentTab();
        const employeeContainer = document.getElementById(filterId);
        if (!employeeContainer) return;
        
        const employeeItems = employeeContainer.querySelectorAll('.employee-item');
        employeeItems.forEach(item => {
            // 현재 표시되는 직원들만 선택
            if (item.style.display !== 'none') {
                const checkbox = item.querySelector('.employee-checkbox');
                if (checkbox) checkbox.checked = true;
            }
        });
        
        // 캘린더 새로고침
        refreshCalendar();
    };
    
    // 전체해제 함수
    window.deselectAllEmployees = function(filterId) {
        const activeTab = getCurrentDepartmentTab();
        const employeeContainer = document.getElementById(filterId);
        if (!employeeContainer) return;
        
        const employeeItems = employeeContainer.querySelectorAll('.employee-item');
        employeeItems.forEach(item => {
            // 현재 표시되는 직원들만 해제
            if (item.style.display !== 'none') {
                const checkbox = item.querySelector('.employee-checkbox');
                if (checkbox) checkbox.checked = false;
            }
        });
        
        // 캘린더 새로고침
        refreshCalendar();
    };
    
    // 직원 선택 섹션 토글 함수
    window.toggleEmployeeSection = function() {
        const content = document.getElementById('employee-section-content');
        const icon = document.getElementById('employee-section-icon');
        
        if (content.style.display === 'none') {
            // 펼치기
            content.style.display = 'block';
            icon.style.transform = 'rotate(0deg)';
        } else {
            // 접기
            content.style.display = 'none';
            icon.style.transform = 'rotate(-90deg)';
        }
    };
    
    // 일정 추가 버튼 (이제 링크로 변경됨)
    
    
    // 뷰 전환 관련 함수들
    function switchView(newView) {
        console.log('Switching from', currentView, 'to', newView);
        
        if (currentView === newView) {
            // 드롭다운만 닫기
            const dropdown = document.getElementById('viewDropdown');
            dropdown.classList.add('scale-95', 'opacity-0', 'pointer-events-none');
            dropdown.classList.remove('scale-100', 'opacity-100');
            return;
        }
        
        // 모든 뷰 숨기기
        document.getElementById('monthView').style.display = 'none';
        document.getElementById('dayView').style.display = 'none';
        
        // 새 뷰 표시
        const newViewElement = document.getElementById(newView + 'View');
        if (newView === 'month') {
            newViewElement.style.display = 'flex';
        } else {
            newViewElement.style.display = 'block';
        }
        
        // 현재 뷰 업데이트
        currentView = newView;
        
        // 뷰 텍스트 업데이트
        const viewTexts = {
            'day': '일간 보기',
            'month': '월간 보기'
        };
        document.getElementById('currentViewText').textContent = viewTexts[newView];
        
        // 드롭다운 강제로 닫기
        const dropdown = document.getElementById('viewDropdown');
        dropdown.classList.add('scale-95', 'opacity-0', 'pointer-events-none');
        dropdown.classList.remove('scale-100', 'opacity-100');
        
        // 해당 뷰 렌더링 및 제목 업데이트
        if (newView === 'month') {
            renderCalendar();
            updateMonthTitle();
        } else if (newView === 'day') {
            renderDayView();
            updateDayTitle();
        }
        
        console.log('View switched to', newView);
    }
    
    
    // 일간 뷰 렌더링
    function renderDayView() {
        const dayViewContainer = document.getElementById('dayView');
        dayViewContainer.innerHTML = `
            <div class="flex h-full flex-col overflow-hidden">
                <!-- 상단 헤더 (모바일) -->
                <div class="sticky top-0 z-10 grid flex-none grid-cols-7 bg-white text-xs text-gray-500 shadow ring-1 ring-black/5 md:hidden dark:bg-gray-900 dark:text-gray-400 dark:shadow-none dark:ring-white/20">
                    ${generateDayHeader()}
                </div>
                
                <!-- 일정 통계 -->
                <div id="dayViewStats" class="bg-gray-50 dark:bg-gray-800/50 border-b border-gray-200 dark:border-gray-600 px-4 py-2 text-sm text-gray-600 dark:text-gray-300" style="display: none;">
                    <!-- 통계 내용이 여기에 동적으로 추가됩니다 -->
                </div>
                
                <!-- 메인 컨텐츠 -->
                <div class="flex flex-1 overflow-hidden">
                    <!-- 시간 라벨 컬럼 -->
                    <div class="w-14 flex-none bg-white border-r border-gray-200 dark:bg-gray-900 dark:border-gray-600">
                        <div class="overflow-y-auto h-full">
                            ${generateTimeLabels()}
                        </div>
                    </div>
                    
                    <!-- 일정 표시 영역 -->
                    <div class="flex-1 relative overflow-y-auto bg-white dark:bg-gray-900">
                        <div class="relative" style="height: 960px;"> <!-- 16시간 * 60px (6AM-10PM) -->
                            ${generateDayTimeGrid()}
                            <ol class="absolute inset-0" id="dayEventsList"></ol>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 일간 뷰 이벤트 로드
        loadDayEvents();
    }
    
    // 헬퍼 함수들 (간단한 구현)
    
    function generateDayHeader() {
        const today = new Date(currentDate);
        const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
        return Array.from({length: 7}, (_, i) => {
            const date = new Date(today);
            date.setDate(today.getDate() - today.getDay() + i);
            const isToday = date.toDateString() === new Date().toDateString();
            const isSelected = date.toDateString() === currentDate.toDateString();
            return `<button type="button" class="flex flex-col items-center pb-1.5 pt-3">
                <span>${dayNames[i]}</span>
                <span class="mt-3 flex size-8 items-center justify-center rounded-full text-base font-semibold ${
                    isSelected ? 'bg-gray-900 text-white dark:bg-white dark:text-gray-900' :
                    isToday ? 'text-indigo-600 dark:text-indigo-400' :
                    'text-gray-900 dark:text-white'
                }">${date.getDate()}</span>
            </button>`;
        }).join('');
    }
    
    function generateTimeLabels() {
        let html = '';
        for (let i = 6; i <= 22; i++) { // 6AM~10PM
            const time12 = i === 12 ? '12PM' : i < 12 ? i + 'AM' : (i - 12) + 'PM';
            html += `<div class="flex h-[60px] items-start justify-end pr-2 text-xs text-gray-500 dark:text-gray-400" style="padding-top: 8px;">${time12}</div>`;
        }
        return html;
    }
    
    function generateDayTimeGrid() {
        let html = '';
        for (let i = 0; i < 17; i++) { // 6AM~10PM (17시간)
            html += `<div class="absolute left-0 right-0 border-t border-gray-200 dark:border-gray-600" style="top: ${i * 60}px; height: 60px;"></div>`;
        }
        return html;
    }
    
    function generateDayEvents() {
        return '<ol class="col-start-1 row-start-1"></ol>';
    }
    
    
    // 일간 뷰 이벤트 로드
    function loadDayEvents() {
        const activeTab = getCurrentDepartmentTab();
        const checkedEmployees = getCheckedEmployees();
        
        // 선택된 날짜
        const dayStart = new Date(currentDate);
        dayStart.setHours(0, 0, 0, 0);
        
        const dayEnd = new Date(currentDate);
        dayEnd.setHours(23, 59, 59, 999);
        
        // 로컬 날짜 문자열 생성 (시간대 문제 해결)
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const day = String(currentDate.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        
        // 부서 필터링 적용 (서버 API용 부서명 매핑)
        let mappedDepartment = activeTab;
        if (activeTab !== 'all') {
            const departmentMapping = {
                'admin': '관리부서',
                'engine_oil': '엔진오일팀',
                'insurance': '보험영업팀', 
                'happycall': '해피콜팀'
            };
            mappedDepartment = departmentMapping[activeTab] || activeTab;
        }
        console.log('일간보기 부서 매핑:', activeTab, '→', mappedDepartment);
        
        const params = new URLSearchParams({
            start: dateStr + 'T00:00:00',
            end: dateStr + 'T23:59:59',
            assignees: checkedEmployees.join(',')
        });
        
        // 전체 부서가 아닐 때만 department 파라미터 추가
        if (activeTab !== 'all') {
            params.set('department', mappedDepartment);
        }
        
        const finalUrl = `{% url "scheduling:api_events" %}?${params}`;
        console.log('일간보기 필터 파라미터:', {
            activeTab: activeTab,
            mappedDepartment: mappedDepartment,
            assignees: checkedEmployees,
            assigneesString: checkedEmployees.join(','),
            date: dateStr,
            finalUrl: finalUrl
        });
        
        fetch(finalUrl)
            .then(response => {
                console.log('일간보기 서버 응답 상태:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(events => {
                console.log('일간보기 서버에서 받은 데이터:', events);
                console.log('일간보기 이벤트 타입:', typeof events, Array.isArray(events));
                
                renderDayEvents(events);
                console.log('일간 뷰 이벤트 로드 완료:', events.length + '개');
            })
            .catch(error => {
                console.error('일간 뷰 이벤트 로드 실패:', error);
                // 일간뷰에서 빈 상태 표시
                renderDayEvents([]);
            });
    }
    
    
    // 일간 뷰 이벤트 렌더링
    function renderDayEvents(events) {
        const eventsList = document.getElementById('dayEventsList');
        const statsEl = document.getElementById('dayViewStats');
        if (!eventsList) return;
        
        eventsList.innerHTML = '';
        
        // 부서별 통계 계산
        const departmentStats = {};
        events.forEach(event => {
            const dept = event.assignee_department || event.extendedProps?.assignee_department || event.extendedProps?.department || '기타';
            departmentStats[dept] = (departmentStats[dept] || 0) + 1;
        });
        
        // 통계 표시
        if (events.length > 0) {
            const statsText = Object.entries(departmentStats).map(([dept, count]) => `${dept} ${count}건`).join(', ');
            statsEl.innerHTML = `총 ${events.length}건 (${statsText})`;
            statsEl.style.display = 'block';
        } else {
            statsEl.style.display = 'none';
        }
        
        // 부서별 색상 매핑 (실제 데이터에서 오는 부서명에 맞춤)
        const departmentColors = {
            'all': { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700', hover: 'hover:bg-blue-100', darkBg: 'dark:bg-blue-900/20', darkBorder: 'dark:border-blue-500/30', darkHover: 'dark:hover:bg-blue-900/30', darkText: 'dark:text-blue-300', textSecondary: 'text-blue-500', darkTextSecondary: 'dark:text-blue-400' },
            '관리부서': { bg: 'bg-purple-50', border: 'border-purple-200', text: 'text-purple-700', hover: 'hover:bg-purple-100', darkBg: 'dark:bg-purple-900/20', darkBorder: 'dark:border-purple-500/30', darkHover: 'dark:hover:bg-purple-900/30', darkText: 'dark:text-purple-300', textSecondary: 'text-purple-600', darkTextSecondary: 'dark:text-purple-400' },
            '엔진오일팀': { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700', hover: 'hover:bg-blue-100', darkBg: 'dark:bg-blue-900/20', darkBorder: 'dark:border-blue-500/30', darkHover: 'dark:hover:bg-blue-900/30', darkText: 'dark:text-blue-300', textSecondary: 'text-blue-500', darkTextSecondary: 'dark:text-blue-400' },
            '보험영업팀': { bg: 'bg-emerald-50', border: 'border-emerald-200', text: 'text-emerald-700', hover: 'hover:bg-emerald-100', darkBg: 'dark:bg-emerald-900/20', darkBorder: 'dark:border-emerald-500/30', darkHover: 'dark:hover:bg-emerald-900/30', darkText: 'dark:text-emerald-300', textSecondary: 'text-emerald-600', darkTextSecondary: 'dark:text-emerald-400' },
            '해피콜팀': { bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-700', hover: 'hover:bg-orange-100', darkBg: 'dark:bg-orange-900/20', darkBorder: 'dark:border-orange-500/30', darkHover: 'dark:hover:bg-orange-900/30', darkText: 'dark:text-orange-300', textSecondary: 'text-orange-600', darkTextSecondary: 'dark:text-orange-400' },
            // 기존 영어명도 유지 (호환성)
            'admin': { bg: 'bg-purple-50', border: 'border-purple-200', text: 'text-purple-700', hover: 'hover:bg-purple-100', darkBg: 'dark:bg-purple-900/20', darkBorder: 'dark:border-purple-500/30', darkHover: 'dark:hover:bg-purple-900/30', darkText: 'dark:text-purple-300', textSecondary: 'text-purple-600', darkTextSecondary: 'dark:text-purple-400' },
            'engine_oil': { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700', hover: 'hover:bg-blue-100', darkBg: 'dark:bg-blue-900/20', darkBorder: 'dark:border-blue-500/30', darkHover: 'dark:hover:bg-blue-900/30', darkText: 'dark:text-blue-300', textSecondary: 'text-blue-500', darkTextSecondary: 'dark:text-blue-400' },
            'insurance': { bg: 'bg-emerald-50', border: 'border-emerald-200', text: 'text-emerald-700', hover: 'hover:bg-emerald-100', darkBg: 'dark:bg-emerald-900/20', darkBorder: 'dark:border-emerald-500/30', darkHover: 'dark:hover:bg-emerald-900/30', darkText: 'dark:text-emerald-300', textSecondary: 'text-emerald-600', darkTextSecondary: 'dark:text-emerald-400' },
            'happycall': { bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-700', hover: 'hover:bg-orange-100', darkBg: 'dark:bg-orange-900/20', darkBorder: 'dark:border-orange-500/30', darkHover: 'dark:hover:bg-orange-900/30', darkText: 'dark:text-orange-300', textSecondary: 'text-orange-600', darkTextSecondary: 'dark:text-orange-400' }
        };
        
        // 겹치는 이벤트 그룹을 찾는 함수
        function findOverlappingGroups(events) {
            const groups = [];
            
            events.forEach(event => {
                const eventStart = new Date(event.start).getTime();
                const eventEnd = new Date(event.end).getTime();
                
                // 이 이벤트와 겹치는 그룹을 찾기
                let foundGroup = null;
                for (let group of groups) {
                    for (let groupEvent of group) {
                        const groupStart = new Date(groupEvent.start).getTime();
                        const groupEnd = new Date(groupEvent.end).getTime();
                        
                        // 겹침 확인: 시작 시간이 다른 이벤트의 끝 시간 전이고, 끝 시간이 다른 이벤트의 시작 시간 후인 경우
                        if (eventStart < groupEnd && eventEnd > groupStart) {
                            foundGroup = group;
                            break;
                        }
                    }
                    if (foundGroup) break;
                }
                
                if (foundGroup) {
                    foundGroup.push(event);
                } else {
                    groups.push([event]);
                }
            });
            
            return groups;
        }
        
        // 겹치는 이벤트 그룹들 찾기
        const overlapGroups = findOverlappingGroups(events);
        
        // 각 이벤트의 겹침 정보 계산
        const eventOverlapInfo = new Map();
        
        overlapGroups.forEach(group => {
            // 그룹 내에서 시작 시간 순으로 정렬
            group.sort((a, b) => new Date(a.start).getTime() - new Date(b.start).getTime());
            
            group.forEach((event, index) => {
                eventOverlapInfo.set(event, { 
                    maxOverlapCount: group.length, 
                    overlapIndex: index 
                });
            });
        });
        
        events.forEach(event => {
            const eventDate = new Date(event.start);
            const eventEnd = new Date(event.end);
            
            const startHour = eventDate.getHours();
            const endHour = eventEnd.getHours();
            
            // 6AM 이전이나 10PM 이후 이벤트는 표시하지 않음
            if (endHour < 6 || startHour > 22) {
                return;
            }
            
            // 시간을 픽셀 위치로 계산 (1시간 = 60px, 6AM 기준으로 조정)
            const startMinute = eventDate.getMinutes();
            const endMinute = eventEnd.getMinutes();
            
            // 6AM 이전 시작하는 이벤트는 6AM부터 표시
            const displayStartHour = Math.max(startHour, 6);
            const displayEndHour = Math.min(endHour, 22);
            
            const topPosition = (displayStartHour - 6) * 60 + (displayStartHour === startHour ? startMinute : 0);
            const endPosition = (displayEndHour - 6) * 60 + (displayEndHour === endHour ? endMinute : 60);
            
            const height = Math.max(endPosition - topPosition, 45); // 최소 45px 높이 (2줄 텍스트 수용)
            
            // 겹침 정보 가져오기
            const { maxOverlapCount, overlapIndex } = eventOverlapInfo.get(event);
            
            // 너비와 위치 계산 (겹치는 이벤트들이 나란히 표시되도록)
            const widthPercentage = 100 / maxOverlapCount;
            const leftPercentage = widthPercentage * overlapIndex;
            
            // 부서별 색상 가져오기 (여러 가능한 필드 확인)
            const assigneeDepartment = event.assignee_department || event.extendedProps?.assignee_department || event.extendedProps?.department || 'all';
            const colors = departmentColors[assigneeDepartment] || departmentColors['all'];
            
            console.log('Event department mapping:', event.title, '→', assigneeDepartment, colors);
            
            const eventItem = document.createElement('li');
            eventItem.className = 'absolute';
            eventItem.style.top = `${topPosition}px`;
            eventItem.style.left = `calc(${leftPercentage}% + 8px)`;
            eventItem.style.width = `calc(${widthPercentage}% - 4px)`;
            eventItem.style.height = `${height}px`;
            eventItem.style.zIndex = '10';
            
            const eventDiv = document.createElement('div');
            eventDiv.className = `w-full h-full ${colors.bg} border ${colors.border} rounded p-1 text-xs cursor-pointer ${colors.hover} ${colors.darkBg} ${colors.darkBorder} ${colors.darkHover} flex flex-col overflow-hidden`;
            
            // 높이에 따른 스마트 내용 구성
            let content = '';
            
            if (height <= 32) {
                // 매우 짧은 일정 (30분 이하): 제목만 표시
                content = `<div class="font-semibold ${colors.text} ${colors.darkText} truncate leading-tight text-center flex items-center justify-center h-full">${event.title}</div>`;
            } else if (height <= 50) {
                // 짧은 일정 (30분~1시간): 제목 + 시간
                const displayStartMinute = displayStartHour === startHour ? startMinute : 0;
                const displayEndMinute = displayEndHour === endHour ? endMinute : 0;
                content = `
                    <div class="font-semibold ${colors.text} ${colors.darkText} truncate leading-tight">${event.title}</div>
                    <div class="${colors.textSecondary} ${colors.darkTextSecondary} text-xs leading-tight mt-1">${displayStartHour.toString().padStart(2, '0')}:${displayStartMinute.toString().padStart(2, '0')}-${displayEndHour.toString().padStart(2, '0')}:${displayEndMinute.toString().padStart(2, '0')}</div>
                `;
            } else {
                // 긴 일정 (1시간 이상): 제목 + 시간 + 부서
                const displayStartMinute = displayStartHour === startHour ? startMinute : 0;
                const displayEndMinute = displayEndHour === endHour ? endMinute : 0;
                content = `
                    <div class="font-semibold ${colors.text} ${colors.darkText} truncate leading-tight">${event.title}</div>
                    <div class="${colors.textSecondary} ${colors.darkTextSecondary} text-xs leading-tight mt-1">${displayStartHour.toString().padStart(2, '0')}:${displayStartMinute.toString().padStart(2, '0')} - ${displayEndHour.toString().padStart(2, '0')}:${displayEndMinute.toString().padStart(2, '0')}</div>
                    ${assigneeDepartment !== 'all' ? `<div class="${colors.textSecondary} ${colors.darkTextSecondary} text-xs opacity-75 leading-tight mt-1">${assigneeDepartment}</div>` : ''}
                `;
            }
            
            eventDiv.innerHTML = content;
            
            eventDiv.addEventListener('click', () => {
                showEventModal(event);
            });
            
            eventItem.appendChild(eventDiv);
            eventsList.appendChild(eventItem);
        });
    }
    
    // 뷰 선택 드롭다운 이벤트
    document.getElementById('viewSelector').addEventListener('click', function(e) {
        e.stopPropagation();
        const dropdown = document.getElementById('viewDropdown');
        const isHidden = dropdown.classList.contains('opacity-0');
        
        if (isHidden) {
            dropdown.classList.remove('scale-95', 'opacity-0', 'pointer-events-none');
            dropdown.classList.add('scale-100', 'opacity-100');
        } else {
            dropdown.classList.add('scale-95', 'opacity-0', 'pointer-events-none');
            dropdown.classList.remove('scale-100', 'opacity-100');
        }
    });
    
    // 뷰 선택 아이템 클릭 이벤트
    document.querySelectorAll('#viewDropdown a').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const view = this.dataset.view;
            console.log('View item clicked:', view);
            switchView(view);
        });
    });
    
    // 드롭다운 외부 클릭시 닫기
    document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('viewDropdown');
        const selector = document.getElementById('viewSelector');
        
        if (!dropdown.contains(e.target) && !selector.contains(e.target)) {
            dropdown.classList.add('scale-95', 'opacity-0', 'pointer-events-none');
            dropdown.classList.remove('scale-100', 'opacity-100');
        }
    });
    
    // URL 파라미터에서 특정 이벤트 ID 확인 및 강조 표시
    function checkForHighlightEvent() {
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('event');
        
        if (eventId) {
            console.log('이벤트 강조 요청:', eventId);
            // 이벤트를 찾을 때까지 최대 5초 대기
            let attempts = 0;
            const maxAttempts = 50;
            
            const findAndHighlightEvent = () => {
                attempts++;
                
                // 현재 로드된 이벤트들 중에서 해당 ID를 가진 이벤트 찾기
                let foundEvent = null;
                if (window.currentEvents) {
                    foundEvent = window.currentEvents.find(event => event.id == eventId);
                }
                
                if (foundEvent) {
                    console.log('이벤트 발견:', foundEvent);
                    
                    // 해당 이벤트가 있는 날짜로 이동
                    const eventDate = new Date(foundEvent.start);
                    currentDate = new Date(eventDate.getFullYear(), eventDate.getMonth(), 1);
                    
                    // 캘린더 다시 렌더링
                    renderCalendar();
                    updateMonthTitle();
                    
                    // 약간의 지연 후 이벤트 모달 표시 및 강조
                    setTimeout(() => {
                        // 이벤트 강조 표시
                        highlightEvent(foundEvent);
                        
                        // 이벤트 모달 자동 열기
                        showEventModal(foundEvent);
                        
                        // URL에서 파라미터 제거
                        const newUrl = new URL(window.location);
                        newUrl.searchParams.delete('event');
                        window.history.replaceState({}, document.title, newUrl);
                    }, 500);
                    
                } else if (attempts < maxAttempts) {
                    // 아직 이벤트가 로드되지 않았으면 다시 시도
                    setTimeout(findAndHighlightEvent, 100);
                } else {
                    console.log('이벤트를 찾을 수 없습니다:', eventId);
                }
            };
            
            // 이벤트 검색 시작
            findAndHighlightEvent();
        }
    }
    
    // 이벤트 강조 표시 함수
    function highlightEvent(event) {
        // 기존 강조 제거
        document.querySelectorAll('.highlighted-event').forEach(el => {
            el.classList.remove('highlighted-event');
        });
        
        // DOM에서 해당 이벤트 요소들 찾기
        const eventElements = document.querySelectorAll(`[data-event-id="${event.id}"]`);
        eventElements.forEach(element => {
            element.classList.add('highlighted-event');
            
            // 스크롤해서 해당 이벤트가 보이도록
            element.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center',
                inline: 'nearest'
            });
        });
    }
    
    // 이벤트가 로드된 후 강조 표시 체크
    const originalLoadEvents = loadEvents;
    loadEvents = function() {
        originalLoadEvents.call(this);
        // 이벤트 로드 후 약간의 지연을 두고 강조 표시 체크
        setTimeout(checkForHighlightEvent, 200);
    };
    
    // 페이지 로드시 강조 표시 체크
    setTimeout(checkForHighlightEvent, 1000);
});
</script>
{% endblock %}