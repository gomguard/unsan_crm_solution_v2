{% extends 'base.html' %}

{% block title %}데이터 업로드{% endblock %}

{% block extra_head %}
<style>
.upload-zone {
    border: 2px dashed #cbd5e0;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    background: #f7fafc;
    transition: all 0.3s ease;
}
.upload-zone:hover {
    border-color: #4299e1;
    background: #ebf8ff;
}
.upload-zone.dragover {
    border-color: #3182ce;
    background: #bee3f8;
}

/* 파일 input 숨기기 */
#id_file {
    display: none;
}

/* 데이터 형식 카드 높이 통일 */
.format-card {
    min-height: 380px;
    display: flex;
    flex-direction: column;
}
.format-card .card-content {
    flex: 1;
}
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- 헤더 -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">데이터 업로드</h3>

                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        현재 등록 데이터: 고객 {{ upload_stats.total_customers }}명, 차량 {{ upload_stats.total_vehicles }}대, 서비스 {{ upload_stats.total_services }}건
                    </div>
                    <p class="text-sm text-gray-500">Excel 또는 CSV 파일을 업로드하여 데이터를 일괄 등록합니다</p>
                </div>
                <div class="flex-shrink-0 ml-6">
                    
                    
                </div>
            </div>
        </div>

        <!-- 업로드 폼 -->
        <form method="post" enctype="multipart/form-data" class="p-6">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 업로드 설정 -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">업로드 설정</h3>
                    
                    <!-- 업로드 타입 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">업로드 타입</label>
                        {{ form.upload_type }}
                    </div>

                    <!-- 중복 처리 방식 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">중복 처리 방식</label>
                        {% for radio in form.duplicate_handling %}
                            <div class="flex items-center mb-2">
                                {{ radio.tag }}
                                <label class="ml-2 text-sm text-gray-700">{{ radio.choice_label }}</label>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- 파일 업로드 -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">파일 선택</h3>
                    
                    <div class="upload-zone" onclick="document.getElementById('id_file').click();">
                        <div class="text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="mt-4">
                                <p class="text-sm text-gray-600">클릭하여 파일 선택 또는 드래그 앤 드롭</p>
                                <p class="text-xs text-gray-500 mt-1">Excel (.xlsx) 또는 CSV (.csv) 파일</p>
                                <p class="text-xs text-gray-500">최대 50MB</p>
                            </div>
                        </div>
                    </div>
                    
                    {{ form.file }}
                    {% if form.file.errors %}
                        <div class="text-red-600 text-sm">{{ form.file.errors }}</div>
                    {% endif %}
                    <div class="mt-8">
                    <div class="flex justify-center space-x-4">
                        <a href="{% url 'core:download_template' 'customers' %}" 
                        class="group relative flex items-center justify-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 hover:border-gray-400 dark:hover:border-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            고객 데이터 템플릿
                        </a>
                        
                        <a href="{% url 'core:download_template' 'vehicles' %}" 
                        class="group relative flex items-center justify-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 hover:border-gray-400 dark:hover:border-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            차량 데이터 템플릿
                        </a>
                        
                        <a href="{% url 'core:download_template' 'services' %}" 
                        class="group relative flex items-center justify-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 hover:border-gray-400 dark:hover:border-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            서비스 데이터 템플릿
                        </a>
                    </div>
                </div>
                 <!-- 업로드 진행 상황 -->
            <div id="uploadProgress" class="mt-6 hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white">업로드 진행 중</h4>
                        <div class="flex items-center">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-indigo-600"></div>
                            <span id="progressPercent" class="ml-2 text-sm font-medium text-gray-900 dark:text-white">0%</span>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-4">
                        <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    
                    <!-- Status Message -->
                    <p id="statusMessage" class="text-sm text-gray-600 dark:text-gray-400">업로드를 준비하고 있습니다...</p>
                    
                    <!-- Current Stats -->
                    <div class="mt-4 grid grid-cols-4 gap-4 text-center">
                        <div>
                            <div id="successCount" class="text-lg font-bold text-green-600">0</div>
                            <div class="text-xs text-gray-500">성공</div>
                        </div>
                        <div>
                            <div id="updatedCount" class="text-lg font-bold text-blue-600">0</div>
                            <div class="text-xs text-gray-500">업데이트</div>
                        </div>
                        <div>
                            <div id="skippedCount" class="text-lg font-bold text-yellow-600">0</div>
                            <div class="text-xs text-gray-500">건너뜀</div>
                        </div>
                        <div>
                            <div id="errorCount" class="text-lg font-bold text-red-600">0</div>
                            <div class="text-xs text-gray-500">오류</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 업로드 버튼 -->
            <div class="mt-8">
                <button type="submit" id="uploadButton" class="w-full group relative flex items-center justify-center px-6 py-3 text-sm font-medium text-white bg-indigo-600 border border-indigo-600 rounded-lg hover:bg-indigo-700 hover:border-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    데이터 업로드 실행
                </button>
            </div>

                </div>
               
                <!-- Excel 템플릿 다운로드 -->
                
            </div>
            
            

            
            <!-- 구분선 -->
            <div class="mt-10 mb-8">
                <div class="border-t border-gray-200 dark:border-gray-700"></div>
            </div>

            <!-- 데이터 형식 안내 -->
            <div class="mt-12">
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">데이터 형식 안내</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">각 데이터 유형별 필수 컬럼과 형식을 확인하세요</p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- 고객 데이터 형식 -->
                    <div class="format-card bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-md transition-shadow duration-200">
                        <div class="p-6 card-content">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="p-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg mr-3">
                                        <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"/>
                                        </svg>
                                    </div>
                                    <h4 class="text-base font-semibold text-gray-900 dark:text-white">고객 데이터</h4>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">필수 컬럼</h5>
                                    <div class="space-y-1">
                                        <span class="inline-block px-2 py-1 text-xs bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 rounded mr-2 mb-1">name</span>
                                        <span class="inline-block px-2 py-1 text-xs bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 rounded mr-2 mb-1">phone</span>
                                    </div>
                                </div>
                                
                                <div>
                                    <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">선택 컬럼</h5>
                                    <div class="space-y-1">
                                        <span class="inline-block px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded mr-2 mb-1">email</span>
                                        <span class="inline-block px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded mr-2 mb-1">address_main</span>
                                        <span class="inline-block px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded mr-2 mb-1">membership_status</span>
                                        <span class="inline-block px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded mr-2 mb-1">customer_grade</span>
                                        <span class="inline-block px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded mr-2 mb-1">company_name</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="px-6 py-3 bg-gray-50 dark:bg-gray-700/50 border-t border-gray-200 dark:border-gray-600">
                            <a href="{% url 'core:download_template' 'customers' %}" 
                               class="inline-flex items-center justify-center w-full px-4 py-2 text-sm font-medium text-indigo-700 dark:text-indigo-300 bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-200 dark:border-indigo-700 rounded-lg hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition-colors duration-200">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Excel 템플릿 다운로드
                            </a>
                        </div>
                    </div>

                    <!-- 차량 데이터 형식 -->
                    <div class="format-card bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-md transition-shadow duration-200">
                        <div class="p-6 card-content">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg mr-3">
                                        <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m8.25 4.5V16.5a1.5 1.5 0 013-1.5 3.375 3.375 0 016.75 0V20.25m-9-10.5a3.375 3.375 0 016.75 0m-6.75 0L21 10.125m0 0a1.5 1.5 0 00-1.5-1.5h-3.375c-.621 0-1.125.504-1.125 1.125v2.25c0 .621.504 1.125 1.125 1.125h3.375a1.5 1.5 0 001.5-1.5V10.125z"/>
                                        </svg>
                                    </div>
                                    <h4 class="text-base font-semibold text-gray-900 dark:text-white">차량 데이터</h4>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">필수 컬럼</h5>
                                    <div class="space-y-1">
                                        <span class="inline-block px-2 py-1 text-xs bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 rounded mr-2 mb-1">vehicle_number</span>
                                        <span class="inline-block px-2 py-1 text-xs bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 rounded mr-2 mb-1">customer_phone</span>
                                    </div>
                                </div>
                                
                                <div>
                                    <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">선택 컬럼</h5>
                                    <div class="space-y-1">
                                        <span class="inline-block px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded mr-2 mb-1">model</span>
                                        <span class="inline-block px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded mr-2 mb-1">year</span>
                                        <span class="inline-block px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded mr-2 mb-1">model_detail</span>
                                        <span class="inline-block px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded mr-2 mb-1">mileage</span>
                                        <span class="inline-block px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded mr-2 mb-1">fuel_type</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="px-6 py-3 bg-gray-50 dark:bg-gray-700/50 border-t border-gray-200 dark:border-gray-600">
                            <a href="{% url 'core:download_template' 'vehicles' %}" 
                               class="inline-flex items-center justify-center w-full px-4 py-2 text-sm font-medium text-blue-700 dark:text-blue-300 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors duration-200">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Excel 템플릿 다운로드
                            </a>
                        </div>
                    </div>

                    <!-- 서비스 데이터 형식 -->
                    <div class="format-card bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-md transition-shadow duration-200">
                        <div class="p-6 card-content">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="p-2 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg mr-3">
                                        <svg class="w-5 h-5 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        </svg>
                                    </div>
                                    <h4 class="text-base font-semibold text-gray-900 dark:text-white">서비스 데이터</h4>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">필수 컬럼</h5>
                                    <div class="space-y-1">
                                        <span class="inline-block px-2 py-1 text-xs bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 rounded mr-2 mb-1">customer_phone</span>
                                        <span class="inline-block px-2 py-1 text-xs bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 rounded mr-2 mb-1">service_type</span>
                                        <span class="inline-block px-2 py-1 text-xs bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 rounded mr-2 mb-1">service_date</span>
                                        <span class="inline-block px-2 py-1 text-xs bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 rounded mr-2 mb-1">status</span>
                                    </div>
                                </div>
                                
                                <div>
                                    <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">선택 컬럼</h5>
                                    <div class="space-y-1">
                                        <span class="inline-block px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded mr-2 mb-1">vehicle_number</span>
                                        <span class="inline-block px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded mr-2 mb-1">description</span>
                                        <span class="inline-block px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded mr-2 mb-1">priority</span>
                                        <span class="inline-block px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded mr-2 mb-1">estimated_price</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="px-6 py-3 bg-gray-50 dark:bg-gray-700/50 border-t border-gray-200 dark:border-gray-600">
                            <a href="{% url 'core:download_template' 'services' %}" 
                               class="inline-flex items-center justify-center w-full px-4 py-2 text-sm font-medium text-emerald-700 dark:text-emerald-300 bg-emerald-50 dark:bg-emerald-900/30 border border-emerald-200 dark:border-emerald-700 rounded-lg hover:bg-emerald-100 dark:hover:bg-emerald-900/50 transition-colors duration-200">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Excel 템플릿 다운로드
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// 파일 드래그 앤 드롭 기능
document.addEventListener('DOMContentLoaded', function() {
    const uploadZone = document.querySelector('.upload-zone');
    const fileInput = document.getElementById('id_file');
    const uploadForm = document.querySelector('form');
    const uploadButton = document.getElementById('uploadButton');
    const uploadProgress = document.getElementById('uploadProgress');
    
    let uploadInProgress = false;
    
    // 드래그 앤 드롭 이벤트
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            updateFileName(files[0].name);
        }
    });
    
    // 파일 선택 시 파일명 표시
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            updateFileName(e.target.files[0].name);
        }
    });
    
    function updateFileName(fileName) {
        const uploadZone = document.querySelector('.upload-zone');
        uploadZone.innerHTML = `
            <div class="text-center">
                <svg class="mx-auto h-12 w-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="mt-4">
                    <p class="text-sm text-gray-900 font-medium">${fileName}</p>
                    <p class="text-xs text-gray-500 mt-1">클릭하여 다른 파일 선택</p>
                </div>
            </div>
        `;
    }
    
    // 폼 제출 시 업로드 진행 표시
    uploadForm.addEventListener('submit', function(e) {
        if (uploadInProgress) {
            e.preventDefault();
            return;
        }
        
        // 파일이 선택되었는지 확인
        if (!fileInput.files || fileInput.files.length === 0) {
            alert('업로드할 파일을 선택해주세요.');
            e.preventDefault();
            return;
        }
        
        // AJAX로 업로드 처리하기 위해 기본 제출 방지
        e.preventDefault();
        
        // 업로드 진행 상황 표시
        showUploadProgress();
        uploadInProgress = true;
        
        // 버튼 비활성화
        uploadButton.disabled = true;
        uploadButton.innerHTML = `
            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
            업로드 중...
        `;
        
        // FormData로 폼 데이터 준비
        const formData = new FormData(uploadForm);
        
        // AJAX로 업로드 시작
        startUpload(formData);
    });
    
    function showUploadProgress() {
        uploadProgress.classList.remove('hidden');
        updateStatus('파일을 분석하고 있습니다...', 10);
    }
    
    function updateStatus(message, percent) {
        document.getElementById('statusMessage').textContent = message;
        document.getElementById('progressPercent').textContent = percent + '%';
        document.getElementById('progressBar').style.width = percent + '%';
    }
    
    function updateCounts(success = 0, updated = 0, skipped = 0, errors = 0) {
        document.getElementById('successCount').textContent = success;
        document.getElementById('updatedCount').textContent = updated;
        document.getElementById('skippedCount').textContent = skipped;
        document.getElementById('errorCount').textContent = errors;
    }
    
    function startUpload(formData) {
        // 1단계: progress_key 생성
        fetch('/dashboard/upload/start/', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const progressKey = data.progress_key;
                
                // progress_key를 폼데이터에 추가
                formData.append('progress_key', progressKey);
                
                // 2단계: 진행률 폴링 시작
                checkProgress(progressKey);
                
                // 3단계: 실제 업로드 시작
                return fetch(uploadForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                });
            } else {
                throw new Error(data.error || '업로드 준비 실패');
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateStatus('업로드 완료!', 100);
                updateCounts(
                    data.results.success,
                    data.results.updated, 
                    data.results.skipped,
                    data.results.errors
                );
                
                // 잠시 후 페이지 새로고침
                setTimeout(() => {
                    location.reload();
                }, 3000);
            } else {
                throw new Error(data.error || '업로드 실패');
            }
        })
        .catch(error => {
            console.error('업로드 오류:', error);
            
            if (error.message.includes('fetch')) {
                alert('서버와의 연결이 끊어졌습니다. 대용량 파일의 경우 처리 시간이 오래 걸릴 수 있습니다.\n\n잠시 후 페이지를 새로고침해서 결과를 확인해주세요.');
                
                // 10초 후 자동 새로고침
                setTimeout(() => {
                    if (confirm('페이지를 새로고침하여 업로드 결과를 확인하시겠습니까?')) {
                        location.reload();
                    }
                }, 10000);
            } else {
                alert('업로드 중 오류가 발생했습니다: ' + error.message);
                resetUploadForm();
            }
        });
    }
    
    function checkProgress(progressKey) {
        if (!progressKey) return;
        
        const pollProgress = () => {
            fetch(`/dashboard/upload/progress/${progressKey}/`)
            .then(response => response.json())
            .then(data => {
                updateStatus(data.message, data.percent);
                updateCounts(
                    data.results.success,
                    data.results.updated,
                    data.results.skipped,
                    data.results.errors
                );
                
                // 100% 미만이면 계속 폴링
                if (data.percent < 100) {
                    setTimeout(pollProgress, 1000);
                }
            })
            .catch(error => {
                console.error('진행률 확인 오류:', error);
                // 에러가 나도 계속 시도 (최대 20번, 대용량 처리를 위해 증가)
                if (!pollProgress.retryCount) pollProgress.retryCount = 0;
                if (pollProgress.retryCount < 20) {
                    pollProgress.retryCount++;
                    setTimeout(pollProgress, 3000); // 더 긴 간격으로 재시도
                } else {
                    console.log('진행률 확인을 포기했습니다. 업로드는 백그라운드에서 계속 진행됩니다.');
                    updateStatus('업로드가 백그라운드에서 진행 중입니다...', 50);
                }
            });
        };
        
        pollProgress();
    }
    
    function resetUploadForm() {
        uploadInProgress = false;
        uploadButton.disabled = false;
        uploadButton.innerHTML = `
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
            데이터 업로드 실행
        `;
        uploadProgress.classList.add('hidden');
    }
});

// 업로드 타입에 따른 도움말 표시
document.getElementById('id_upload_type').addEventListener('change', function() {
    // 여기에 타입별 도움말 표시 로직 추가 가능
});
</script>
{% endblock %}