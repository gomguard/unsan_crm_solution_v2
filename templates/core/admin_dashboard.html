{% extends 'base.html' %}

{% block title %}ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.stat-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}
.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
.progress-ring {
    width: 60px;
    height: 60px;
}
.progress-ring__circle {
    transition: stroke-dasharray 0.35s;
    transform: rotate(-90deg);
    transform-origin: 50% 50%;
}
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
                <p class="mt-1 text-sm text-gray-500">{{ today|date:"Yë…„ mì›” dì¼" }} í˜„ì¬ ìš´ì˜ í˜„í™©</p>
            </div>
            <div class="flex space-x-3">
                <a href="{% url 'employees:employee_list' %}" 
                   class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    ğŸ‘¥ ì§ì› ê´€ë¦¬
                </a>
                <a href="{% url 'happycall:dashboard' %}" 
                   class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                    ğŸ“ í•´í”¼ì½œ ê´€ë¦¬
                </a>
            </div>
        </div>
    </div>

    <!-- ì „ì²´ í˜„í™© ì¹´ë“œ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="stat-card bg-white shadow rounded-lg p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-lg bg-blue-500 flex items-center justify-center text-white text-xl">
                    ğŸ‘¥
                </div>
                <div class="ml-4">
                    <div class="text-2xl font-bold text-gray-900">{{ total_customers }}</div>
                    <div class="text-sm text-gray-500">ì „ì²´ ê³ ê°</div>
                    <div class="text-xs text-green-600">+{{ week_customers }} (ì´ë²ˆ ì£¼)</div>
                </div>
            </div>
        </div>

        <div class="stat-card bg-white shadow rounded-lg p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-lg bg-green-500 flex items-center justify-center text-white text-xl">
                    ğŸ”§
                </div>
                <div class="ml-4">
                    <div class="text-2xl font-bold text-gray-900">{{ total_services }}</div>
                    <div class="text-sm text-gray-500">ì „ì²´ ì„œë¹„ìŠ¤</div>
                    <div class="text-xs text-green-600">+{{ month_services }} (ì´ë²ˆ ë‹¬)</div>
                </div>
            </div>
        </div>

        <div class="stat-card bg-white shadow rounded-lg p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-lg bg-purple-500 flex items-center justify-center text-white text-xl">
                    ğŸ“
                </div>
                <div class="ml-4">
                    <div class="text-2xl font-bold text-gray-900">{{ total_happycalls }}</div>
                    <div class="text-sm text-gray-500">ì „ì²´ í•´í”¼ì½œ</div>
                    <div class="text-xs text-green-600">+{{ week_happycalls }} (ì´ë²ˆ ì£¼)</div>
                </div>
            </div>
        </div>

        <div class="stat-card bg-white shadow rounded-lg p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-lg bg-orange-500 flex items-center justify-center text-white text-xl">
                    ğŸ‘¨â€ğŸ’¼
                </div>
                <div class="ml-4">
                    <div class="text-2xl font-bold text-gray-900">{{ total_employees }}</div>
                    <div class="text-sm text-gray-500">ì¬ì§ ì§ì›</div>
                    <div class="text-xs text-gray-400">í™œì„± ìƒíƒœ</div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- ì§ì›ë³„ í•´í”¼ì½œ ë°°ì • í˜„í™© -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-lg font-semibold text-gray-900">ì§ì›ë³„ í•´í”¼ì½œ ë°°ì • í˜„í™©</h2>
                <a href="{% url 'employees:employee_list' %}" class="text-sm text-indigo-600 hover:text-indigo-800">ì „ì²´ë³´ê¸° â†’</a>
            </div>
            
            <div class="space-y-4">
                {% for stat in employee_happycall_stats %}
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center text-sm font-medium">
                            {{ stat.employee.user.username|first|upper }}
                        </div>
                        <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">
                                {{ stat.employee.user.get_full_name|default:stat.employee.user.username }}
                            </div>
                            <div class="text-xs text-gray-500">{{ stat.employee.get_position_display }}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="flex space-x-4">
                            <div class="text-center">
                                <div class="text-lg font-semibold text-orange-600">{{ stat.pending_calls }}</div>
                                <div class="text-xs text-gray-500">ì§„í–‰ì¤‘</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-semibold text-green-600">{{ stat.completed_calls_week }}</div>
                                <div class="text-xs text-gray-500">ì£¼ì™„ë£Œ</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-semibold text-gray-600">{{ stat.total_assigned }}</div>
                                <div class="text-xs text-gray-500">ì „ì²´</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-8 text-gray-500">
                    ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- í•´í”¼ì½œ ë‹¨ê³„ë³„ í˜„í™© -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-lg font-semibold text-gray-900">í•´í”¼ì½œ ë‹¨ê³„ë³„ í˜„í™©</h2>
                <a href="{% url 'happycall:dashboard' %}" class="text-sm text-indigo-600 hover:text-indigo-800">ìƒì„¸ë³´ê¸° â†’</a>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="text-center p-3 bg-blue-50 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600">{{ happycall_stage_stats.1st_pending }}</div>
                    <div class="text-sm text-gray-600">1ì°¨ ëŒ€ê¸°</div>
                </div>
                <div class="text-center p-3 bg-green-50 rounded-lg">
                    <div class="text-2xl font-bold text-green-600">{{ happycall_stage_stats.1st_completed }}</div>
                    <div class="text-sm text-gray-600">1ì°¨ ì™„ë£Œ</div>
                </div>
                <div class="text-center p-3 bg-yellow-50 rounded-lg">
                    <div class="text-2xl font-bold text-yellow-600">{{ happycall_stage_stats.2nd_pending }}</div>
                    <div class="text-sm text-gray-600">2ì°¨ ëŒ€ê¸°</div>
                </div>
                <div class="text-center p-3 bg-green-50 rounded-lg">
                    <div class="text-2xl font-bold text-green-600">{{ happycall_stage_stats.2nd_completed }}</div>
                    <div class="text-sm text-gray-600">2ì°¨ ì™„ë£Œ</div>
                </div>
                <div class="text-center p-3 bg-purple-50 rounded-lg">
                    <div class="text-2xl font-bold text-purple-600">{{ happycall_stage_stats.3rd_pending }}</div>
                    <div class="text-sm text-gray-600">3ì°¨ ëŒ€ê¸°</div>
                </div>
                <div class="text-center p-3 bg-green-50 rounded-lg">
                    <div class="text-2xl font-bold text-green-600">{{ happycall_stage_stats.completed }}</div>
                    <div class="text-sm text-gray-600">ì „ì²´ ì™„ë£Œ</div>
                </div>
            </div>
            
            <!-- ì°¨íŠ¸ ì˜ì—­ -->
            <div class="mt-6">
                <canvas id="stageChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- ì„œë¹„ìŠ¤ íƒ€ì…ë³„ í†µê³„ -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-lg font-semibold text-gray-900">ì„œë¹„ìŠ¤ íƒ€ì…ë³„ í†µê³„ (ì´ë²ˆ ë‹¬)</h2>
                <a href="{% url 'services:service_list' %}" class="text-sm text-indigo-600 hover:text-indigo-800">ì „ì²´ë³´ê¸° â†’</a>
            </div>
            
            <div class="space-y-3">
                {% for service in service_type_stats %}
                <div class="flex items-center justify-between">
                    <div class="text-sm font-medium text-gray-900">{{ service.service_type__name }}</div>
                    <div class="flex items-center">
                        <div class="w-20 bg-gray-200 rounded-full h-2 mr-3">
                            <div class="bg-indigo-600 h-2 rounded-full" style="width: {{ service.count }}%"></div>
                        </div>
                        <div class="text-sm font-semibold text-gray-600">{{ service.count }}</div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4 text-gray-500">
                    ì´ë²ˆ ë‹¬ ì„œë¹„ìŠ¤ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- ë‹¤ê°€ì˜¤ëŠ” ì¼ì • -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-lg font-semibold text-gray-900">ë‹¤ê°€ì˜¤ëŠ” ì¼ì • (ì¼ì£¼ì¼)</h2>
                <a href="{% url 'scheduling:calendar' %}" class="text-sm text-indigo-600 hover:text-indigo-800">ìº˜ë¦°ë” â†’</a>
            </div>
            
            <div class="space-y-3">
                {% for schedule in upcoming_schedules %}
                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                    <div>
                        <div class="text-sm font-medium text-gray-900">{{ schedule.title }}</div>
                        <div class="text-xs text-gray-500">
                            {{ schedule.assignee.get_full_name|default:schedule.assignee.username }} 
                            Â· {{ schedule.department.display_name }}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium text-gray-900">{{ schedule.start_datetime|date:"m/d" }}</div>
                        <div class="text-xs text-gray-500">{{ schedule.start_datetime|date:"H:i" }}</div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4 text-gray-500">
                    ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
// í•´í”¼ì½œ ë‹¨ê³„ë³„ ì°¨íŠ¸
const ctx = document.getElementById('stageChart').getContext('2d');
const stageChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: ['1ì°¨ ëŒ€ê¸°', '1ì°¨ ì™„ë£Œ', '2ì°¨ ëŒ€ê¸°', '2ì°¨ ì™„ë£Œ', '3ì°¨ ëŒ€ê¸°', 'ì „ì²´ ì™„ë£Œ'],
        datasets: [{
            data: [
                {{ happycall_stage_stats.1st_pending }},
                {{ happycall_stage_stats.1st_completed }},
                {{ happycall_stage_stats.2nd_pending }},
                {{ happycall_stage_stats.2nd_completed }},
                {{ happycall_stage_stats.3rd_pending }},
                {{ happycall_stage_stats.completed }}
            ],
            backgroundColor: [
                '#3B82F6', '#10B981', '#F59E0B', '#10B981', '#8B5CF6', '#059669'
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
</script>
{% endblock %}