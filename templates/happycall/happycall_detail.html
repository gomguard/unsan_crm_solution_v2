{% extends 'base.html' %}
{% load humanize %}

{% block title %}해피콜 상세정보 - {{ happycall.service_request.customer.name }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <div class="flex h-screen">
        <!-- 고객 정보 사이드바 -->
        <aside class="hidden lg:flex lg:flex-shrink-0 lg:w-80 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700">
            <div class="flex flex-col h-full w-full overflow-y-auto">
            <div class="p-6 w-full">
                <div class="space-y-6">
                    <!-- 고객 기본 정보 -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">{{ happycall.service_request.customer.name }} 고객님</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-500 dark:text-gray-400">연락처:</span>
                                <span class="text-gray-900 dark:text-white font-medium">{{ happycall.service_request.customer.phone }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 dark:text-gray-400">주소:</span>
                                <span class="text-gray-900 dark:text-white text-xs">{{ happycall.service_request.customer.address }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-500 dark:text-gray-400">해피콜 단계:</span>
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                                    {% if happycall.call_stage|slice:":3" == '1st' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                                    {% elif happycall.call_stage|slice:":3" == '2nd' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                                    {% elif happycall.call_stage|slice:":3" == '3rd' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200
                                    {% elif happycall.call_stage|slice:":3" == '4th' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200
                                    {% else %}bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200{% endif %}">
                                    {{ happycall.get_call_stage_display }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- 차량 정보 -->
                    {% if customer_vehicles %}
                    <div>
                        <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-3">보유 차량</h4>
                        <div class="space-y-2">
                            {% for vehicle in customer_vehicles %}
                            <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="font-medium text-gray-900 dark:text-white">{{ vehicle.vehicle_number }}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">
                                    {{ vehicle.model }} {% if vehicle.year %}({{ vehicle.year }}년){% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- 서비스 이력 -->
                    {% if service_history %}
                    <div>
                        <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-3">최근 서비스 이력</h4>
                        <div class="space-y-3">
                            {% for service in service_history %}
                            <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="font-medium text-gray-900 dark:text-white text-sm">{{ service.service_type.name }}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">{{ service.service_date|date:"Y.m.d" }}</div>
                                </div>
                                <div class="flex items-center space-x-2 text-xs">
                                    <span class="inline-flex px-2 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                        {{ service.service_type.category }}
                                    </span>
                                    {% if service.vehicle %}
                                    <span class="text-gray-600 dark:text-gray-400">{{ service.vehicle.vehicle_number }}</span>
                                    {% endif %}
                                </div>
                                {% if service.service_detail %}
                                <div class="mt-2 text-xs text-gray-600 dark:text-gray-400">
                                    {{ service.service_detail|truncatewords:8 }}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- 매출 기록 -->
                    {% if revenue_records %}
                    <div>
                        <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-3">매출 기록</h4>
                        <div class="space-y-2">
                            {% for revenue in revenue_records %}
                            <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <div class="text-sm font-medium text-gray-900 dark:text-white">{{ revenue.revenue_type }}</div>
                                    <div class="text-sm font-semibold text-green-600 dark:text-green-400">{{ revenue.expected_amount|intcomma }}원</div>
                                </div>
                                <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">{{ revenue.proposed_at|date:"Y.m.d" }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            </div>
        </aside>

        <!-- 메인 컨텐츠 영역 -->
        <main class="flex-1 flex flex-col h-full overflow-hidden">
            <div class="flex-1 overflow-y-auto">
            <div class="p-8">
                <!-- 헤더 -->
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">해피콜 통화</h1>
                        <p class="text-gray-600 dark:text-gray-400 mt-1">{{ happycall.service_request.customer.name }} 고객님</p>
                    </div>
                    <div class="flex space-x-3">
                        <a href="{% url 'happycall:list' %}" 
                           class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md hover:bg-gray-700">
                            목록으로
                        </a>
                    </div>
                </div>

                <!-- 모바일에서 고객 정보 간략 표시 -->
                <div class="lg:hidden mb-6 p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-2">{{ happycall.service_request.customer.name }} 고객님</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{{ happycall.service_request.customer.phone }}</p>
                </div>

                <div class="space-y-6">
                    <!-- 통화 수행 폼 -->
                    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">통화 내용 입력</h3>
                        </div>
                        <div class="p-6">
                            <form method="post" action="{% url 'happycall:execute' happycall.pk %}" class="space-y-6">
                                {% csrf_token %}
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- 통화 결과 -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">통화 결과</label>
                                        <select name="contact_result" required class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                            <option value="">선택해주세요</option>
                                            <option value="success" {% if happycall.first_call_success or happycall.second_call_success or happycall.third_call_success or happycall.fourth_call_success %}selected{% endif %}>통화 성공</option>
                                            <option value="no_answer">부재중</option>
                                            <option value="busy">통화중</option>
                                            <option value="refused">통화 거부</option>
                                            <option value="wrong_number">잘못된 번호</option>
                                        </select>
                                    </div>

                                    <!-- 만족도 -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">서비스 만족도</label>
                                        <select name="overall_satisfaction" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                            <option value="">선택해주세요</option>
                                            <option value="5" {% if happycall.overall_satisfaction == 5 %}selected{% endif %}>매우 만족 (5점)</option>
                                            <option value="4" {% if happycall.overall_satisfaction == 4 %}selected{% endif %}>만족 (4점)</option>
                                            <option value="3" {% if happycall.overall_satisfaction == 3 %}selected{% endif %}>보통 (3점)</option>
                                            <option value="2" {% if happycall.overall_satisfaction == 2 %}selected{% endif %}>불만족 (2점)</option>
                                            <option value="1" {% if happycall.overall_satisfaction == 1 %}selected{% endif %}>매우 불만족 (1점)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- 통화 메모 -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">통화 내용</label>
                                    <textarea name="call_notes" rows="4" 
                                              class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                              placeholder="통화 내용을 입력해주세요...">{{ happycall.first_call_notes|default:happycall.second_call_notes|default:happycall.third_call_notes|default:happycall.fourth_call_notes }}</textarea>
                                </div>

                                <!-- 고객 피드백 -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">고객 의견</label>
                                    <textarea name="customer_feedback" rows="3"
                                              class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                              placeholder="고객이 말씀하신 의견이나 건의사항을 입력해주세요...">{{ happycall.customer_feedback }}</textarea>
                                </div>

                                <!-- 체크박스 옵션들 -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="flex items-center">
                                        <input type="checkbox" name="additional_service_interest" value="true" 
                                               {% if happycall.additional_service_interest %}checked{% endif %}
                                               class="h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded focus:ring-indigo-500">
                                        <label class="ml-2 text-sm text-gray-700 dark:text-gray-300">추가 서비스에 관심 있음</label>
                                    </div>

                                    <div class="flex items-center">
                                        <input type="checkbox" name="callback_needed" value="true"
                                               class="h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded focus:ring-indigo-500">
                                        <label class="ml-2 text-sm text-gray-700 dark:text-gray-300">다시 연락 필요</label>
                                    </div>
                                </div>

                                <div class="flex justify-end space-x-3 pt-4">
                                    <button type="button" onclick="history.back()" 
                                            class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 text-sm font-medium rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
                                        취소
                                    </button>
                                    <button type="submit" 
                                            class="px-6 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        통화 내용 저장
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- 기존 통화 기록 (있는 경우) -->
                    {% if result %}
                    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">이전 통화 기록</h3>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {% if result.overall_satisfaction %}
                                <div>
                                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400">만족도:</span>
                                    <div class="mt-1">
                                        <span class="text-sm text-gray-900 dark:text-white">{{ result.overall_satisfaction }}점</span>
                                        <div class="flex mt-1">
                                            {% for i in "12345" %}
                                            <span class="h-4 w-4 {% if result.overall_satisfaction >= i|add:0 %}text-yellow-400{% else %}text-gray-300 dark:text-gray-600{% endif %}">★</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                {% if result.first_call_notes or result.second_call_notes or result.third_call_notes or result.fourth_call_notes %}
                                <div>
                                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400">통화 내용:</span>
                                    <p class="text-sm text-gray-900 dark:text-white mt-1">
                                        {{ result.first_call_notes|default:result.second_call_notes|default:result.third_call_notes|default:result.fourth_call_notes }}
                                    </p>
                                </div>
                                {% endif %}
                            </div>

                            {% if result.customer_feedback %}
                            <div class="mt-6">
                                <span class="text-sm font-medium text-gray-500 dark:text-gray-400">고객 의견:</span>
                                <p class="text-sm text-gray-900 dark:text-white mt-1">{{ result.customer_feedback }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}