{% extends 'base.html' %}
{% load humanize %}

{% block title %}해피콜 상세정보 - {{ happycall.service_request.customer.name }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <div class="flex h-screen">
        <!-- 고객 정보 사이드바 -->
        <aside class="hidden lg:flex lg:flex-shrink-0 lg:w-80 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700">
            <div class="flex flex-col h-full w-full overflow-y-auto">
            <div class="p-6 w-full">
                <div class="space-y-6">
                    <!-- 고객 기본 정보 -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">{{ happycall.service_request.customer.name }} 고객님</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-500 dark:text-gray-400">연락처:</span>
                                <span class="text-gray-900 dark:text-white font-medium">{{ happycall.service_request.customer.phone }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 dark:text-gray-400">주소:</span>
                                <span class="text-gray-900 dark:text-white text-xs">{{ happycall.service_request.customer.address }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-500 dark:text-gray-400">해피콜 단계:</span>
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                                    {% if happycall.call_stage|slice:":3" == '1st' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                                    {% elif happycall.call_stage|slice:":3" == '2nd' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                                    {% elif happycall.call_stage|slice:":3" == '3rd' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200
                                    {% elif happycall.call_stage|slice:":3" == '4th' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200
                                    {% else %}bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200{% endif %}">
                                    {{ happycall.get_call_stage_display }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- 차량 정보 -->
                    {% if customer_vehicles %}
                    <div>
                        <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-3">보유 차량</h4>
                        <div class="space-y-2">
                            {% for vehicle in customer_vehicles %}
                            <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="font-medium text-gray-900 dark:text-white">{{ vehicle.vehicle_number }}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">
                                    {{ vehicle.model }} {% if vehicle.year %}({{ vehicle.year }}년){% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- 서비스 이력 -->
                    {% if service_history %}
                    <div>
                        <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-3">최근 서비스 이력</h4>
                        <div class="space-y-3">
                            {% for service in service_history %}
                            <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="font-medium text-gray-900 dark:text-white text-sm">{{ service.service_type.name }}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">{{ service.service_date|date:"Y.m.d" }}</div>
                                </div>
                                <div class="flex items-center space-x-2 text-xs">
                                    <span class="inline-flex px-2 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                        {{ service.service_type.category }}
                                    </span>
                                    {% if service.vehicle %}
                                    <span class="text-gray-600 dark:text-gray-400">{{ service.vehicle.vehicle_number }}</span>
                                    {% endif %}
                                </div>
                                {% if service.service_detail %}
                                <div class="mt-2 text-xs text-gray-600 dark:text-gray-400">
                                    {{ service.service_detail|truncatewords:8 }}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- 매출 기록 -->
                    {% if revenue_records %}
                    <div>
                        <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-3">매출 기록</h4>
                        <div class="space-y-2">
                            {% for revenue in revenue_records %}
                            <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <div class="text-sm font-medium text-gray-900 dark:text-white">{{ revenue.revenue_type }}</div>
                                    <div class="text-sm font-semibold text-green-600 dark:text-green-400">{{ revenue.expected_amount|intcomma }}원</div>
                                </div>
                                <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">{{ revenue.proposed_at|date:"Y.m.d" }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            </div>
        </aside>

        <!-- 메인 컨텐츠 영역 -->
        <main class="flex-1 flex flex-col h-full overflow-hidden">
            <div class="flex-1 overflow-y-auto">
            <div class="p-8">
                <!-- 헤더 -->
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">해피콜 통화</h1>
                        <p class="text-gray-600 dark:text-gray-400 mt-1">{{ happycall.service_request.customer.name }} 고객님</p>
                    </div>
                    <div class="flex space-x-3">
                        <a href="{% url 'happycall:list' %}" 
                           class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md hover:bg-gray-700">
                            목록으로
                        </a>
                    </div>
                </div>

                <!-- 모바일에서 고객 정보 간략 표시 -->
                <div class="lg:hidden mb-6 p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-2">{{ happycall.service_request.customer.name }} 고객님</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{{ happycall.service_request.customer.phone }}</p>
                </div>

                <div class="space-y-6">
                    <!-- 수행/수정 폼 또는 결과 표시 -->
                    {% if edit_mode or is_pending %}
                    <!-- 해피콜 수행/수정 폼 -->
                    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                                    {% if edit_mode %}해피콜 수정{% else %}해피콜 수행{% endif %}
                                </h3>
                                {% if not is_pending %}
                                <a href="?edit=false" class="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                                    취소
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        
                        <form method="post" class="p-6 space-y-4">
                            {% csrf_token %}
                            
                            <!-- 통화 결과 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    통화 결과 <span class="text-red-500">*</span>
                                </label>
                                <div class="mt-1 space-y-2">
                                    <div class="flex items-center">
                                        <input type="radio" name="contact_result" value="connected" id="connected" required
                                               {% if result.contact_result == 'connected' or happycall.first_call_success or happycall.second_call_success or happycall.third_call_success %}checked{% endif %}
                                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 dark:border-gray-600">
                                        <label for="connected" class="ml-3 text-sm text-gray-700 dark:text-gray-300">
                                            연결됨 - 통화 완료
                                        </label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="radio" name="contact_result" value="no_answer" id="no_answer"
                                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 dark:border-gray-600">
                                        <label for="no_answer" class="ml-3 text-sm text-gray-700 dark:text-gray-300">
                                            부재중 - 응답 없음
                                        </label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="radio" name="contact_result" value="refused" id="refused"
                                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 dark:border-gray-600">
                                        <label for="refused" class="ml-3 text-sm text-gray-700 dark:text-gray-300">
                                            통화 거부
                                        </label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="radio" name="contact_result" value="number_changed" id="number_changed"
                                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 dark:border-gray-600">
                                        <label for="number_changed" class="ml-3 text-sm text-gray-700 dark:text-gray-300">
                                            번호 변경
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- 만족도 점수 (통화 연결시만) -->
                            <div id="satisfaction-section">
                                <label for="satisfaction_score" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    만족도 점수 (1-5점)
                                </label>
                                <select name="satisfaction_score" id="satisfaction_score"
                                        class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    <option value="">선택하세요</option>
                                    <option value="1" {% if happycall.overall_satisfaction == 1 %}selected{% endif %}>1점 - 매우 불만족</option>
                                    <option value="2" {% if happycall.overall_satisfaction == 2 %}selected{% endif %}>2점 - 불만족</option>
                                    <option value="3" {% if happycall.overall_satisfaction == 3 %}selected{% endif %}>3점 - 보통</option>
                                    <option value="4" {% if happycall.overall_satisfaction == 4 %}selected{% endif %}>4점 - 만족</option>
                                    <option value="5" {% if happycall.overall_satisfaction == 5 %}selected{% endif %}>5점 - 매우 만족</option>
                                </select>
                            </div>

                            <!-- 고객 피드백 -->
                            <div id="feedback-section">
                                <label for="feedback" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    고객 피드백
                                </label>
                                <textarea name="feedback" id="feedback" rows="4"
                                          placeholder="고객이 전달한 피드백을 입력하세요..."
                                          class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">{{ happycall.customer_feedback }}</textarea>
                            </div>

                            <!-- 후속 조치 -->
                            <div id="followup-section">
                                <div class="space-y-4">
                                    <div class="flex items-center">
                                        <input type="checkbox" name="follow_up_needed" id="follow_up_needed" 
                                               {% if happycall.follow_up_needed %}checked{% endif %}
                                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 dark:border-gray-600 rounded">
                                        <label for="follow_up_needed" class="ml-3 text-sm text-gray-700 dark:text-gray-300">
                                            후속 조치 필요
                                        </label>
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <input type="checkbox" name="additional_service_interest" id="additional_service_interest"
                                               {% if happycall.additional_service_interest %}checked{% endif %}
                                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 dark:border-gray-600 rounded">
                                        <label for="additional_service_interest" class="ml-3 text-sm text-gray-700 dark:text-gray-300">
                                            추가 서비스 관심 있음
                                        </label>
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <input type="checkbox" name="no_call_request" id="no_call_request"
                                               {% if happycall.no_call_request %}checked{% endif %}
                                               class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 dark:border-gray-600 rounded">
                                        <label for="no_call_request" class="ml-3 text-sm text-red-700 dark:text-red-400">
                                            통화 금지 요청 (향후 해피콜 거부)
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- 관심 서비스 유형 (추가 서비스 관심 시만 표시) -->
                            <div id="service-type-section" style="{% if not happycall.additional_service_interest %}display: none;{% endif %}">
                                <label for="interested_service_types" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    관심 서비스 유형
                                </label>
                                <textarea name="interested_service_notes" id="interested_service_notes" rows="2"
                                          placeholder="고객이 관심있어하는 서비스나 후속조치 내용을 기록하세요 (예: 엔진오일 교환, 타이어 교체, 정기점검 등)"
                                          class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">{{ happycall.interested_service_notes|default:'' }}</textarea>
                                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">나중에 실제 서비스 요청 시 해피콜과 연결됩니다.</p>
                            </div>

                            <!-- 메모 -->
                            <div>
                                <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    메모
                                </label>
                                <textarea name="notes" id="notes" rows="3"
                                          placeholder="기타 특이사항이나 메모를 입력하세요..."
                                          class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">{% if happycall.first_call_notes %}{{ happycall.first_call_notes }}{% elif happycall.second_call_notes %}{{ happycall.second_call_notes }}{% elif happycall.third_call_notes %}{{ happycall.third_call_notes }}{% endif %}</textarea>
                            </div>

                            <!-- 버튼들 -->
                            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200 dark:border-gray-700">
                                <a href="{% if edit_mode %}?edit=false{% else %}{% url 'happycall:list' %}{% endif %}" 
                                   class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 text-sm font-medium rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
                                    취소
                                </a>
                                <button type="submit" 
                                        class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700">
                                    {% if edit_mode %}수정 완료{% else %}해피콜 완료{% endif %}
                                </button>
                            </div>
                        </form>
                    </div>
                    {% else %}
                    <!-- 해피콜 결과 표시 -->
                    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">해피콜 결과</h3>
                                <a href="?edit=true" class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-md hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
                                    수정
                                </a>
                            </div>
                        </div>
                        <div class="p-6">
                            {% if result %}
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {% if result.overall_satisfaction %}
                                <div>
                                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400">만족도:</span>
                                    <div class="mt-1">
                                        <span class="text-sm text-gray-900 dark:text-white">{{ result.overall_satisfaction }}점</span>
                                        <div class="flex mt-1">
                                            {% for i in "12345" %}
                                            <span class="h-4 w-4 {% if result.overall_satisfaction >= i|add:0 %}text-yellow-400{% else %}text-gray-300 dark:text-gray-600{% endif %}">★</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <div>
                                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400">통화 상태:</span>
                                    <span class="ml-2 text-sm text-gray-900 dark:text-white">완료됨</span>
                                </div>
                            </div>
                            
                            {% if result.customer_feedback %}
                            <div class="mt-4">
                                <span class="text-sm font-medium text-gray-500 dark:text-gray-400">고객 피드백:</span>
                                <p class="mt-1 text-sm text-gray-900 dark:text-white">{{ result.customer_feedback }}</p>
                            </div>
                            {% endif %}
                            {% else %}
                            <p class="text-gray-500 dark:text-gray-400">아직 해피콜이 수행되지 않았습니다.</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- 기존 통화 기록 (있는 경우) -->
                    {% if result %}
                    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">이전 통화 기록</h3>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {% if result.overall_satisfaction %}
                                <div>
                                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400">만족도:</span>
                                    <div class="mt-1">
                                        <span class="text-sm text-gray-900 dark:text-white">{{ result.overall_satisfaction }}점</span>
                                        <div class="flex mt-1">
                                            {% for i in "12345" %}
                                            <span class="h-4 w-4 {% if result.overall_satisfaction >= i|add:0 %}text-yellow-400{% else %}text-gray-300 dark:text-gray-600{% endif %}">★</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                {% if result.first_call_notes or result.second_call_notes or result.third_call_notes or result.fourth_call_notes %}
                                <div>
                                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400">통화 내용:</span>
                                    <p class="text-sm text-gray-900 dark:text-white mt-1">
                                        {{ result.first_call_notes|default:result.second_call_notes|default:result.third_call_notes|default:result.fourth_call_notes }}
                                    </p>
                                </div>
                                {% endif %}
                            </div>

                            {% if result.customer_feedback %}
                            <div class="mt-6">
                                <span class="text-sm font-medium text-gray-500 dark:text-gray-400">고객 의견:</span>
                                <p class="text-sm text-gray-900 dark:text-white mt-1">{{ result.customer_feedback }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            </div>
        </main>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contactResultInputs = document.querySelectorAll('input[name="contact_result"]');
    const satisfactionSection = document.getElementById('satisfaction-section');
    const feedbackSection = document.getElementById('feedback-section');
    const followupSection = document.getElementById('followup-section');
    const satisfactionScore = document.getElementById('satisfaction_score');
    
    function updateFormSections() {
        const selectedResult = document.querySelector('input[name="contact_result"]:checked');
        if (!selectedResult) return;
        
        const result = selectedResult.value;
        
        if (result === 'connected') {
            // 통화 연결시 - 모든 섹션 활성화
            satisfactionSection.style.display = 'block';
            feedbackSection.style.display = 'block';
            followupSection.style.display = 'block';
            satisfactionScore.required = true;
        } else {
            // 통화 실패시 - 만족도/피드백 숨김
            satisfactionSection.style.display = 'none';
            feedbackSection.style.display = 'none';
            followupSection.style.display = 'none';
            satisfactionScore.required = false;
        }
    }
    
    // 이벤트 리스너 등록
    contactResultInputs.forEach(input => {
        input.addEventListener('change', updateFormSections);
    });
    
    // 초기 설정
    updateFormSections();
    
    // 추가 서비스 관심 체크박스와 서비스 유형 섹션 연동
    const additionalServiceCheckbox = document.getElementById('additional_service_interest');
    const serviceTypeSection = document.getElementById('service-type-section');
    const serviceNotesInput = document.getElementById('interested_service_notes');
    
    if (additionalServiceCheckbox) {
        additionalServiceCheckbox.addEventListener('change', function() {
            if (this.checked) {
                serviceTypeSection.style.display = 'block';
                serviceNotesInput.focus();
            } else {
                serviceTypeSection.style.display = 'none';
                serviceNotesInput.value = '';
            }
        });
        
        // 페이지 로드 시 초기 상태 설정
        if (additionalServiceCheckbox.checked) {
            serviceTypeSection.style.display = 'block';
        }
    }
});
</script>
{% endblock %}