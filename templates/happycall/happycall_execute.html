{% extends 'base.html' %}
{% load humanize %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- 헤더 -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">{{ title }}</h1>
                    <p class="mt-2 text-gray-600 dark:text-gray-400">
                        {{ happycall.service_request.customer.name }} 고객님 - {{ happycall.service_request.customer.get_masked_phone }}
                    </p>
                </div>
                <div class="flex space-x-3">
                    <a href="{% url 'happycall:detail' happycall.pk %}" 
                       class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md hover:bg-gray-700">
                        상세보기
                    </a>
                </div>
            </div>
        </div>

        <!-- 고객 정보 요약 -->
        <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg mb-6">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">고객 정보</h3>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">고객명</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{ happycall.service_request.customer.name }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">전화번호</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white">
                            {% if user.is_superuser %}
                                <a href="tel:{{ happycall.service_request.customer.phone }}" class="text-indigo-600 hover:text-indigo-500">
                                    {{ happycall.service_request.customer.phone }}
                                </a>
                                <span class="ml-2 text-xs text-green-600">[통화가능]</span>
                            {% else %}
                                {{ happycall.service_request.customer.get_masked_phone }}
                                <span class="ml-2 text-xs text-gray-500">[권한필요]</span>
                            {% endif %}
                        </dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">차량</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white">
                            {% if happycall.service_request.vehicle %}
                                {{ happycall.service_request.vehicle.make }} {{ happycall.service_request.vehicle.model }} 
                                ({{ happycall.service_request.vehicle.license_plate }})
                            {% else %}
                                -
                            {% endif %}
                        </dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">서비스 일자</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white">
                            {{ happycall.service_request.created_at|date:"Y년 m월 d일" }}
                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                {{ happycall.service_request.service_type.name }}
                            </div>
                        </dd>
                    </div>
                </div>
            </div>
        </div>

        <!-- 해피콜 수행 폼 -->
        <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ title }} 결과 입력</h3>
            </div>
            
            <form method="post" class="p-6 space-y-6">
                {% csrf_token %}
                
                <!-- 통화 결과 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        통화 결과 <span class="text-red-500">*</span>
                    </label>
                    <div class="mt-2 space-y-2">
                        <div class="flex items-center">
                            <input type="radio" name="contact_result" value="connected" id="connected" required
                                   {% if result.contact_result == 'connected' %}checked{% endif %}
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 dark:border-gray-600">
                            <label for="connected" class="ml-3 text-sm text-gray-700 dark:text-gray-300">
                                연결됨 - 통화 완료
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" name="contact_result" value="no_answer" id="no_answer"
                                   {% if result.contact_result == 'no_answer' %}checked{% endif %}
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 dark:border-gray-600">
                            <label for="no_answer" class="ml-3 text-sm text-gray-700 dark:text-gray-300">
                                부재중 - 응답 없음
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" name="contact_result" value="refused" id="refused"
                                   {% if result.contact_result == 'refused' %}checked{% endif %}
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 dark:border-gray-600">
                            <label for="refused" class="ml-3 text-sm text-gray-700 dark:text-gray-300">
                                통화 거부
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" name="contact_result" value="number_changed" id="number_changed"
                                   {% if result.contact_result == 'number_changed' %}checked{% endif %}
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 dark:border-gray-600">
                            <label for="number_changed" class="ml-3 text-sm text-gray-700 dark:text-gray-300">
                                번호 변경
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 만족도 점수 (통화 연결시만) -->
                <div id="satisfaction-section">
                    <label for="satisfaction_score" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        만족도 점수 (1-5점)
                    </label>
                    <select name="satisfaction_score" id="satisfaction_score"
                            class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="">선택하세요</option>
                        <option value="1" {% if result.satisfaction_score == 1 %}selected{% endif %}>1점 - 매우 불만족</option>
                        <option value="2" {% if result.satisfaction_score == 2 %}selected{% endif %}>2점 - 불만족</option>
                        <option value="3" {% if result.satisfaction_score == 3 %}selected{% endif %}>3점 - 보통</option>
                        <option value="4" {% if result.satisfaction_score == 4 %}selected{% endif %}>4점 - 만족</option>
                        <option value="5" {% if result.satisfaction_score == 5 %}selected{% endif %}>5점 - 매우 만족</option>
                    </select>
                </div>

                <!-- 고객 피드백 -->
                <div id="feedback-section">
                    <label for="feedback" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        고객 피드백
                    </label>
                    <textarea name="feedback" id="feedback" rows="4"
                              placeholder="고객이 전달한 피드백을 입력하세요..."
                              class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">{% if result %}{{ result.feedback }}{% endif %}</textarea>
                </div>

                <!-- 후속 조치 -->
                <div id="followup-section">
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <input type="checkbox" name="follow_up_needed" id="follow_up_needed" 
                                   {% if result.follow_up_needed %}checked{% endif %}
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 dark:border-gray-600 rounded">
                            <label for="follow_up_needed" class="ml-3 text-sm text-gray-700 dark:text-gray-300">
                                후속 조치 필요
                            </label>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" name="additional_service_interest" id="additional_service_interest"
                                   {% if result.additional_service_interest %}checked{% endif %}
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 dark:border-gray-600 rounded">
                            <label for="additional_service_interest" class="ml-3 text-sm text-gray-700 dark:text-gray-300">
                                추가 서비스 관심 있음
                            </label>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" name="no_call_request" id="no_call_request"
                                   {% if result.no_call_request %}checked{% endif %}
                                   class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 dark:border-gray-600 rounded">
                            <label for="no_call_request" class="ml-3 text-sm text-red-700 dark:text-red-400">
                                통화 금지 요청 (향후 해피콜 거부)
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 관심 서비스 유형 (추가 서비스 관심 시만 표시) -->
                <div id="service-type-section" style="display: none;">
                    <label for="interested_service_types" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        관심 서비스 유형
                    </label>
                    <textarea name="interested_service_notes" id="interested_service_notes" rows="2"
                              placeholder="고객이 관심있어하는 서비스나 후속조치 내용을 기록하세요 (예: 엔진오일 교환, 타이어 교체, 정기점검 등)"
                              class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">{% if result %}{{ result.interested_service_notes|default:'' }}{% endif %}</textarea>
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">나중에 실제 서비스 요청 시 해피콜과 연결됩니다.</p>
                </div>

                <!-- 메모 -->
                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        메모
                    </label>
                    <textarea name="notes" id="notes" rows="3"
                              placeholder="기타 특이사항이나 메모를 입력하세요..."
                              class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">{% if result %}{{ result.notes }}{% endif %}</textarea>
                </div>

                <!-- 버튼들 -->
                <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <a href="{% url 'happycall:detail' happycall.pk %}" 
                       class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 text-sm font-medium rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
                        취소
                    </a>
                    <button type="submit" 
                            class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700">
                        {{ title }} 완료
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contactResultInputs = document.querySelectorAll('input[name="contact_result"]');
    const satisfactionSection = document.getElementById('satisfaction-section');
    const feedbackSection = document.getElementById('feedback-section');
    const followupSection = document.getElementById('followup-section');
    const satisfactionScore = document.getElementById('satisfaction_score');
    
    function updateFormSections() {
        const selectedResult = document.querySelector('input[name="contact_result"]:checked');
        if (!selectedResult) return;
        
        const result = selectedResult.value;
        
        if (result === 'connected') {
            // 통화 연결시 - 모든 섹션 활성화
            satisfactionSection.style.display = 'block';
            feedbackSection.style.display = 'block';
            followupSection.style.display = 'block';
            satisfactionScore.required = true;
        } else {
            // 통화 실패시 - 만족도/피드백 숨김
            satisfactionSection.style.display = 'none';
            feedbackSection.style.display = 'none';
            followupSection.style.display = 'none';
            satisfactionScore.required = false;
        }
    }
    
    // 이벤트 리스너 등록
    contactResultInputs.forEach(input => {
        input.addEventListener('change', updateFormSections);
    });
    
    // 초기 설정
    updateFormSections();
    
    // 추가 서비스 관심 체크박스와 서비스 유형 섹션 연동
    const additionalServiceCheckbox = document.getElementById('additional_service_interest');
    const serviceTypeSection = document.getElementById('service-type-section');
    const serviceNotesInput = document.getElementById('interested_service_notes');
    
    if (additionalServiceCheckbox) {
        additionalServiceCheckbox.addEventListener('change', function() {
            if (this.checked) {
                serviceTypeSection.style.display = 'block';
                serviceNotesInput.focus();
            } else {
                serviceTypeSection.style.display = 'none';
                serviceNotesInput.value = '';
            }
        });
        
        // 페이지 로드 시 초기 상태 설정
        if (additionalServiceCheckbox.checked) {
            serviceTypeSection.style.display = 'block';
        }
    }
});
</script>
{% endblock %}