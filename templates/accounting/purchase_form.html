{% extends 'base.html' %}

{% block title %}{% if object %}매입전표 수정{% else %}매입전표 등록{% endif %}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-8">
    <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- 헤더 -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                        {% if object %}매입전표 수정{% else %}매입전표 등록{% endif %}
                    </h1>
                    <p class="mt-2 text-gray-600 dark:text-gray-400">
                        {% if object %}{{ object.voucher_number }} 전표를 수정합니다{% else %}새로운 매입전표를 등록합니다{% endif %}
                    </p>
                </div>
                <a href="{% url 'accounting:purchase_list' %}" 
                   class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md hover:bg-gray-700">
                    목록으로
                </a>
            </div>
        </div>

        <!-- 폼 -->
        <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg">
            <form method="post" class="divide-y divide-gray-200 dark:divide-gray-700">
                {% csrf_token %}
                
                <div class="px-6 py-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-6">기본 정보</h3>
                    
                    <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                        <!-- 공급업체 -->
                        <div class="sm:col-span-2">
                            <label for="{{ form.supplier.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                {{ form.supplier.label }}
                                <span class="text-red-500">*</span>
                            </label>
                            <div class="mt-1">
                                {{ form.supplier }}
                                {% if form.supplier.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.supplier.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <p class="mt-1 text-xs text-gray-500">공급업체를 선택하세요. 신규 업체는 <a href="{% url 'accounting:supplier_create' %}" class="text-indigo-600 hover:text-indigo-500" target="_blank">여기서 등록</a>하세요.</p>
                        </div>

                        <!-- 매입일자 -->
                        <div>
                            <label for="{{ form.purchase_date.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                매입일자
                                <span class="text-red-500">*</span>
                            </label>
                            <div class="mt-1">
                                <input type="date" name="{{ form.purchase_date.name }}" 
                                       value="{{ form.purchase_date.value|date:'Y-m-d'|default:'' }}" 
                                       required
                                       class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                {% if form.purchase_date.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.purchase_date.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <p class="mt-1 text-xs text-gray-500">형식: YYYY-MM-DD (예: 2025-09-03)</p>
                        </div>

                        <!-- 결제방법 -->
                        <div>
                            <label for="{{ form.payment_method.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                {{ form.payment_method.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.payment_method }}
                                {% if form.payment_method.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.payment_method.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- 결제일자 -->
                        <div>
                            <label for="{{ form.payment_date.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                {{ form.payment_date.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.payment_date }}
                                {% if form.payment_date.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.payment_date.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <p class="mt-1 text-xs text-gray-500">결제 완료 시 입력하세요</p>
                        </div>

                        {% if object %}
                        <!-- 결제완료 여부 (수정시에만 표시) -->
                        <div>
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    {{ form.is_paid }}
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="{{ form.is_paid.id_for_label }}" class="font-medium text-gray-700 dark:text-gray-300">
                                        {{ form.is_paid.label }}
                                    </label>
                                    {% if form.is_paid.errors %}
                                    <p class="mt-2 text-sm text-red-600">{{ form.is_paid.errors.0 }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- 적요 -->
                        <div class="sm:col-span-2">
                            <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                {{ form.description.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.description }}
                                {% if form.description.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.description.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 매입 항목 (JavaScript로 동적 추가) -->
                <div class="px-6 py-6" id="purchase-items-section">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">매입 항목</h3>
                        <button type="button" id="add-item-btn" 
                                class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700">
                            + 항목 추가
                        </button>
                    </div>
                    
                    <div id="items-container">
                        <!-- 기존 항목들 표시 -->
                        {% if purchase_items %}
                            {% for item in purchase_items %}
                            <div class="purchase-item bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-4">
                                <div class="grid grid-cols-1 gap-4 sm:grid-cols-6">
                                    <div class="sm:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">품목명</label>
                                        <input type="text" name="item_name[]" value="{{ item.item_name }}" required
                                               class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">수량</label>
                                        <input type="number" name="quantity[]" value="{{ item.quantity }}" step="0.01" min="0" required
                                               class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">단가</label>
                                        <input type="number" name="unit_price[]" value="{{ item.unit_price }}" min="0" required
                                               class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">금액</label>
                                        <input type="number" name="amount[]" value="{{ item.amount }}" readonly
                                               class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-300 shadow-sm bg-gray-100">
                                    </div>
                                    <div class="flex items-end">
                                        <button type="button" class="remove-item-btn px-3 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700">
                                            삭제
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <!-- 새 전표일 경우 빈 항목 하나 -->
                            <div class="purchase-item bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-4">
                                <div class="grid grid-cols-1 gap-4 sm:grid-cols-6">
                                    <div class="sm:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">품목명</label>
                                        <input type="text" name="item_name[]" required
                                               class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">수량</label>
                                        <input type="number" name="quantity[]" step="0.01" min="0" required
                                               class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">단가</label>
                                        <input type="number" name="unit_price[]" min="0" required
                                               class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">금액</label>
                                        <input type="number" name="amount[]" readonly
                                               class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-300 shadow-sm bg-gray-100">
                                    </div>
                                    <div class="flex items-end">
                                        <button type="button" class="remove-item-btn px-3 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700">
                                            삭제
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-600">
                        <div class="flex justify-end">
                            <div class="text-right">
                                <p class="text-lg font-semibold text-gray-900 dark:text-white">
                                    총 금액: <span id="total-amount">0</span>원
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 버튼 -->
                <div class="px-6 py-4 flex justify-end space-x-3">
                    <a href="{% url 'accounting:purchase_list' %}" 
                       class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
                        취소
                    </a>
                    <button type="submit" 
                            class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        {% if object %}수정{% else %}등록{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const itemsContainer = document.getElementById('items-container');
    const addItemBtn = document.getElementById('add-item-btn');
    const totalAmountElement = document.getElementById('total-amount');
    
    // 항목 추가
    addItemBtn.addEventListener('click', function() {
        const newItem = document.querySelector('.purchase-item').cloneNode(true);
        const inputs = newItem.querySelectorAll('input');
        inputs.forEach(input => input.value = '');
        itemsContainer.appendChild(newItem);
        
        // 새 항목에 이벤트 리스너 추가
        addItemEventListeners(newItem);
    });
    
    // 기존 항목들에 이벤트 리스너 추가
    document.querySelectorAll('.purchase-item').forEach(addItemEventListeners);
    
    // 초기 총 금액 계산
    calculateTotal();
    
    function addItemEventListeners(item) {
        // 항목 삭제
        const removeBtn = item.querySelector('.remove-item-btn');
        removeBtn.addEventListener('click', function() {
            if (itemsContainer.children.length > 1) {
                item.remove();
                calculateTotal();
            } else {
                alert('최소 1개 항목은 필요합니다.');
            }
        });
        
        // 수량, 단가 변경 시 금액 계산
        const quantityInput = item.querySelector('input[name="quantity[]"]');
        const unitPriceInput = item.querySelector('input[name="unit_price[]"]');
        const amountInput = item.querySelector('input[name="amount[]"]');
        
        function calculateItemAmount() {
            const quantity = parseFloat(quantityInput.value) || 0;
            const unitPrice = parseFloat(unitPriceInput.value) || 0;
            const amount = quantity * unitPrice;
            amountInput.value = amount;
            calculateTotal();
        }
        
        quantityInput.addEventListener('input', calculateItemAmount);
        unitPriceInput.addEventListener('input', calculateItemAmount);
    }
    
    // 총 금액 계산
    function calculateTotal() {
        let total = 0;
        document.querySelectorAll('input[name="amount[]"]').forEach(function(input) {
            total += parseFloat(input.value) || 0;
        });
        totalAmountElement.textContent = total.toLocaleString();
    }
    
    // 폼 제출 시 총 금액을 hidden field에 설정
    document.querySelector('form').addEventListener('submit', function(e) {
        // 총 금액을 계산해서 hidden field 추가
        let total = 0;
        document.querySelectorAll('input[name="amount[]"]').forEach(function(input) {
            total += parseFloat(input.value) || 0;
        });
        
        const totalInput = document.createElement('input');
        totalInput.type = 'hidden';
        totalInput.name = 'total_amount';
        totalInput.value = total;
        this.appendChild(totalInput);
    });
});
</script>

<style>
/* 다크모드 호환성을 위한 스타일 */
select, input[type="text"], input[type="number"], input[type="date"], textarea {
    @apply block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500;
}

input[type="checkbox"] {
    @apply rounded border-gray-300 dark:border-gray-600 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50;
}
</style>
{% endblock %}