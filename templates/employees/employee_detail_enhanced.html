{% extends 'base.html' %}

{% block title %}{{ employee.user.get_full_name|default:employee.user.username }} - ÏßÅÏõê ÏÉÅÏÑ∏{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.stat-card {
    transition: all 0.3s ease;
}
.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}
.activity-item {
    transition: all 0.2s ease;
}
.activity-item:hover {
    background-color: #f9fafb;
}
.metric-ring {
    position: relative;
    display: inline-block;
}
.metric-ring svg {
    transform: rotate(-90deg);
}
.performance-badge {
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- ÏßÅÏõê ÌîÑÎ°úÌïÑ Ìó§Îçî -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 shadow rounded-lg text-white">
        <div class="px-6 py-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-20 h-20 rounded-full bg-white bg-opacity-20 flex items-center justify-center text-3xl font-bold">
                        {{ employee.user.username|first|upper }}
                    </div>
                    <div class="ml-6">
                        <h1 class="text-3xl font-bold">
                            {{ employee.user.get_full_name|default:employee.user.username }}
                        </h1>
                        <div class="mt-2 flex items-center space-x-4 text-indigo-100">
                            <span class="text-lg">{{ employee.get_position_display }}</span>
                            <span class="text-sm">{{ employee.employee_id }}</span>
                            <span class="text-sm">{{ employee.department.display_name|default:'Î∂ÄÏÑúÏóÜÏùå' }}</span>
                        </div>
                        <div class="mt-3 flex items-center space-x-6 text-sm text-indigo-100">
                            {% if employee.hire_date %}
                            <span>ÏûÖÏÇ¨: {{ employee.hire_date|date:"YÎÖÑ mÏõî dÏùº" }}</span>
                            {% endif %}
                            {% if employee.phone %}
                            <span>üì± {{ employee.phone }}</span>
                            {% endif %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                {% if employee.status == 'active' %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ employee.get_status_display }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold">{{ happycall_stats.total }}</div>
                            <div class="text-sm text-indigo-100">Ï¥ù Ìï¥ÌîºÏΩú</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold">{{ service_stats.total_created }}</div>
                            <div class="text-sm text-indigo-100">ÏÉùÏÑ± ÏÑúÎπÑÏä§</div>
                        </div>
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <a href="{% url 'employees:employee_edit' employee.id %}" 
                           class="px-4 py-2 bg-white text-indigo-600 text-sm font-medium rounded-md hover:bg-gray-50">
                            ÏàòÏ†ï
                        </a>
                        <a href="{% url 'employees:employee_list' %}" 
                           class="px-4 py-2 bg-indigo-500 text-white text-sm font-medium rounded-md hover:bg-indigo-400">
                            Î™©Î°ù
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÌïµÏã¨ ÏÑ±Í≥º ÏßÄÌëú -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Ìï¥ÌîºÏΩú ÏÑ±Í≥º -->
        <div class="stat-card bg-white shadow rounded-lg p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-lg bg-purple-500 flex items-center justify-center text-white text-xl">
                    üìû
                </div>
                <div class="ml-4">
                    <div class="text-2xl font-bold text-gray-900">{{ happycall_stats.pending }}</div>
                    <div class="text-sm text-gray-500">ÏßÑÌñâ Ï§ëÏù∏ ÏΩú</div>
                    <div class="text-xs text-green-600 mt-1">Ïù¥Î≤à Ï£º +{{ happycall_stats.week_completed }}ÏôÑÎ£å</div>
                </div>
            </div>
            <div class="mt-4">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span>ÏÑ±Í≥µÎ•†</span>
                    <span>{{ happycall_stats.success_rate }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-purple-500 h-2 rounded-full" style="width: {{ happycall_stats.success_rate }}%"></div>
                </div>
            </div>
        </div>

        <!-- Îß§Ï∂ú ÏÑ±Í≥º -->
        <div class="stat-card bg-white shadow rounded-lg p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-lg bg-green-500 flex items-center justify-center text-white text-xl">
                    üí∞
                </div>
                <div class="ml-4">
                    <div class="text-2xl font-bold text-gray-900">‚Ç©{{ revenue_stats.total_revenue|floatformat:0 }}</div>
                    <div class="text-sm text-gray-500">Ï¥ù Îß§Ï∂ú Í∏∞Ïó¨</div>
                    <div class="text-xs text-green-600 mt-1">Ïù¥Î≤à Îã¨ +‚Ç©{{ revenue_stats.month_revenue|floatformat:0 }}</div>
                </div>
            </div>
            <div class="mt-4">
                <div class="text-center">
                    <div class="text-sm font-semibold text-gray-900">{{ revenue_stats.revenue_count }}</div>
                    <div class="text-xs text-gray-500">Í±¥Ïàò</div>
                </div>
            </div>
        </div>

        <!-- ÏÑúÎπÑÏä§ Ï≤òÎ¶¨ -->
        <div class="stat-card bg-white shadow rounded-lg p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-lg bg-blue-500 flex items-center justify-center text-white text-xl">
                    üîß
                </div>
                <div class="ml-4">
                    <div class="text-2xl font-bold text-gray-900">{{ service_stats.total_created }}</div>
                    <div class="text-sm text-gray-500">Ï≤òÎ¶¨Ìïú ÏÑúÎπÑÏä§</div>
                    <div class="text-xs text-green-600 mt-1">Ïù¥Î≤à Îã¨ +{{ service_stats.month_created }}Í±¥</div>
                </div>
            </div>
        </div>

        <!-- Í≥†Í∞ù ÎßåÏ°±ÎèÑ -->
        <div class="stat-card bg-white shadow rounded-lg p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-lg bg-yellow-500 flex items-center justify-center text-white text-xl">
                    ‚≠ê
                </div>
                <div class="ml-4">
                    <div class="text-2xl font-bold text-gray-900">{{ happycall_stats.avg_satisfaction }}/5</div>
                    <div class="text-sm text-gray-500">ÌèâÍ∑† ÎßåÏ°±ÎèÑ</div>
                    <div class="text-xs text-gray-500 mt-1">{{ happycall_stats.total }}Í±¥ Í∏∞Ï§Ä</div>
                </div>
            </div>
            <div class="mt-4">
                <div class="flex space-x-1">
                    {% for i in "12345" %}
                        {% if forloop.counter <= happycall_stats.avg_satisfaction %}
                            <span class="text-yellow-400">‚òÖ</span>
                        {% else %}
                            <span class="text-gray-300">‚òÖ</span>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Í∏∞Í∞ÑÎ≥Ñ ÏÑ±Í≥º -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-lg font-semibold text-gray-900">Í∏∞Í∞ÑÎ≥Ñ ÏÑ±Í≥º</h2>
                <div class="text-sm text-gray-500">Ìï¥ÌîºÏΩú Í∏∞Ï§Ä</div>
            </div>
            
            <div class="space-y-4">
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-blue-500 mr-3"></div>
                        <span class="text-sm font-medium text-gray-900">Ïù¥Î≤à Ï£º</span>
                    </div>
                    <div class="text-lg font-bold text-blue-600">{{ happycall_stats.week_completed }}Í±¥</div>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-green-500 mr-3"></div>
                        <span class="text-sm font-medium text-gray-900">Ïù¥Î≤à Îã¨</span>
                    </div>
                    <div class="text-lg font-bold text-green-600">{{ happycall_stats.month_completed }}Í±¥</div>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-purple-500 mr-3"></div>
                        <span class="text-sm font-medium text-gray-900">Î∂ÑÍ∏∞</span>
                    </div>
                    <div class="text-lg font-bold text-purple-600">{{ happycall_stats.quarter_completed }}Í±¥</div>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-orange-500 mr-3"></div>
                        <span class="text-sm font-medium text-gray-900">Ïò¨Ìï¥</span>
                    </div>
                    <div class="text-lg font-bold text-orange-600">{{ happycall_stats.year_completed }}Í±¥</div>
                </div>
            </div>
        </div>

        <!-- ÏÑúÎπÑÏä§ ÌÉÄÏûÖÎ≥Ñ Î∂ÑÌè¨ -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-lg font-semibold text-gray-900">ÏÑúÎπÑÏä§ ÌÉÄÏûÖÎ≥Ñ Ï≤òÎ¶¨ ÌòÑÌô©</h2>
                <div class="text-sm text-gray-500">ÏÉùÏÑ± Í∏∞Ï§Ä</div>
            </div>
            
            <div class="space-y-3">
                {% for service_type in service_stats.types %}
                <div class="flex items-center justify-between">
                    <div class="text-sm font-medium text-gray-900">{{ service_type.service_type__name }}</div>
                    <div class="flex items-center">
                        <div class="w-24 bg-gray-200 rounded-full h-2 mr-3">
                            <div class="bg-indigo-600 h-2 rounded-full" 
                                 style="width: {% widthratio service_type.count service_stats.types.0.count 100 %}%"></div>
                        </div>
                        <div class="text-sm font-semibold text-gray-600 w-8 text-right">{{ service_type.count }}</div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4 text-gray-500">
                    ÏÉùÏÑ±Ìïú ÏÑúÎπÑÏä§Í∞Ä ÏóÜÏäµÎãàÎã§.
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- ÏßÑÌñâ Ï§ëÏù∏ Ìï¥ÌîºÏΩú -->
    {% if pending_calls %}
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold text-gray-900">ÏßÑÌñâ Ï§ëÏù∏ Ìï¥ÌîºÏΩú</h2>
            <span class="bg-orange-100 text-orange-800 text-xs font-medium px-2.5 py-0.5 rounded-full">{{ happycall_stats.pending }}Í±¥</span>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% for call in pending_calls %}
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-sm font-medium text-gray-900">{{ call.service_request.customer.name }}</div>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                        {{ call.get_call_stage_display }}
                    </span>
                </div>
                <div class="text-xs text-gray-500 mb-2">{{ call.service_request.vehicle.vehicle_number }}</div>
                <div class="flex justify-between items-center">
                    <div class="text-xs text-gray-500">
                        {% if call.first_call_scheduled_date %}
                            ÏòàÏ†ï: {{ call.first_call_scheduled_date|date:"m/d H:i" }}
                        {% endif %}
                    </div>
                    <a href="/happycall/{{ call.id }}/" class="text-xs text-purple-600 hover:text-purple-800 font-medium">ÏàòÌñâ</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- ÏµúÍ∑º ÌôúÎèô Ïù¥Î†• -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold text-gray-900">ÏµúÍ∑º ÌôúÎèô Ïù¥Î†•</h2>
            <div class="text-sm text-gray-500">ÏµúÍ∑º 20Í∞ú ÌôúÎèô</div>
        </div>
        
        <div class="space-y-3 max-h-96 overflow-y-auto">
            {% for activity in activities %}
            <div class="activity-item flex items-center p-3 border border-gray-200 rounded-lg">
                <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm mr-3
                    {% if activity.color == 'purple' %}bg-purple-100 text-purple-600
                    {% elif activity.color == 'green' %}bg-green-100 text-green-600
                    {% elif activity.color == 'blue' %}bg-blue-100 text-blue-600
                    {% else %}bg-gray-100 text-gray-600{% endif %}">
                    {{ activity.icon }}
                </div>
                <div class="flex-1">
                    <div class="text-sm font-medium text-gray-900">{{ activity.title }}</div>
                    <div class="text-xs text-gray-500">{{ activity.description }}</div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500">{{ activity.date|date:"m/d H:i" }}</div>
                    <a href="{{ activity.url }}" class="text-xs text-indigo-600 hover:text-indigo-800">Î≥¥Í∏∞</a>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-8 text-gray-500">
                ÏµúÍ∑º ÌôúÎèôÏù¥ ÏóÜÏäµÎãàÎã§.
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ÏõîÎ≥Ñ ÏÑ±Í≥º Ìä∏Î†åÎìú -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold text-gray-900">ÏõîÎ≥Ñ ÏÑ±Í≥º Ìä∏Î†åÎìú</h2>
            <div class="text-sm text-gray-500">ÏµúÍ∑º 6Í∞úÏõî</div>
        </div>
        
        <div class="mb-4">
            <canvas id="performanceChart" height="100"></canvas>
        </div>
        
        <div class="grid grid-cols-6 gap-2 text-center text-xs">
            {% for month in monthly_performance %}
            <div class="p-2 bg-gray-50 rounded">
                <div class="font-semibold text-gray-900">{{ month.month }}</div>
                <div class="text-purple-600">üìû{{ month.happycalls }}</div>
                <div class="text-green-600">üîß{{ month.services }}</div>
                <div class="text-blue-600">‚Ç©{{ month.revenue|floatformat:0 }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
// ÏõîÎ≥Ñ ÏÑ±Í≥º Ìä∏Î†åÎìú Ï∞®Ìä∏
const performanceCtx = document.getElementById('performanceChart').getContext('2d');
const performanceChart = new Chart(performanceCtx, {
    type: 'line',
    data: {
        labels: [{% for month in monthly_performance %}'{{ month.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'ÏôÑÎ£åÎêú Ìï¥ÌîºÏΩú',
            data: [{% for month in monthly_performance %}{{ month.happycalls }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#8B5CF6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            fill: true,
            tension: 0.3
        }, {
            label: 'Ï≤òÎ¶¨Ìïú ÏÑúÎπÑÏä§',
            data: [{% for month in monthly_performance %}{{ month.services }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#10B981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            fill: true,
            tension: 0.3
        }, {
            label: 'Îß§Ï∂ú Í∏∞Ïó¨ (Ï≤úÏõê)',
            data: [{% for month in monthly_performance %}{{ month.revenue|floatformat:0 }}{% if not forloop.last %},{% endif %}{% endfor %}].map(x => Math.round(x / 1000)),
            borderColor: '#3B82F6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.3,
            yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            intersect: false,
        },
        plugins: {
            legend: {
                position: 'top'
            }
        },
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                beginAtZero: true
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                beginAtZero: true,
                grid: {
                    drawOnChartArea: false,
                },
            }
        }
    }
});
</script>
{% endblock %}